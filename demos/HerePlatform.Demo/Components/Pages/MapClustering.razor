@page "/map-clustering"
@rendermode InteractiveServer
@using HerePlatformComponents.Maps.Clustering

<PageTitle>Clustering</PageTitle>

<h3>Marker Clustering Demo</h3>
<p>Cluster large numbers of markers for better performance and readability.</p>

<details class="mb-3">
    <summary class="fw-bold" role="button">Usage</summary>
    <pre class="bg-light border rounded p-3 mt-2 mb-0"><code>@@using HerePlatformComponents.Maps.Clustering

&lt;AdvancedHereMap Options="@@_mapOptions" Height="500px"&gt;

    &lt;!-- Eps = cluster radius in px, MinWeight = min points to form cluster --&gt;
    &lt;MarkerClusterComponent
        DataPoints="@@_dataPoints"
        Eps="32"
        MinWeight="2"
        MinZoom="@@_clusterMinZoom"
        MaxZoom="@@_clusterMaxZoom"
        ClusterSvgTemplate="@@_clusterSvg"
        NoiseSvgTemplate="@@_noiseSvg"
        OnClusterTap="@@OnClusterTap"
        OnNoiseTap="@@OnNoiseTap" /&gt;

&lt;/AdvancedHereMap&gt;

@@code {
    private List&lt;ClusterDataPoint&gt; _dataPoints = new();
    private double? _clusterMinZoom;
    private double? _clusterMaxZoom;

    // SVG templates: {count} and {color} are replaced at render time
    private string _clusterSvg = "&lt;svg xmlns='http://www.w3.org/2000/svg' " +
        "width='50' height='50'&gt;&lt;circle cx='25' cy='25' r='20' " +
        "fill='{color}' opacity='0.8'/&gt;&lt;text x='25' y='30' " +
        "text-anchor='middle' fill='white' font-size='12'&gt;" +
        "{count}&lt;/text&gt;&lt;/svg&gt;";

    private string _noiseSvg = "&lt;svg xmlns='http://www.w3.org/2000/svg' " +
        "width='16' height='16'&gt;&lt;circle cx='8' cy='8' r='6' " +
        "fill='#4285F4' stroke='white' stroke-width='2'/&gt;&lt;/svg&gt;";

    private MapOptions _mapOptions = new()
    {
        Center = new LatLngLiteral(51.0, 10.0),
        Zoom = 6,
        EnableUI = true,
        EnableInteraction = true
    };

    // Generate random data points (lat, lng, weight)
    private void GeneratePoints(int count)
    {
        var rng = new Random(42);
        _dataPoints = new List&lt;ClusterDataPoint&gt;();
        for (int i = 0; i &lt; count; i++)
        {
            _dataPoints.Add(new ClusterDataPoint(
                47.3 + rng.NextDouble() * 7.5,
                6.0 + rng.NextDouble() * 9.0,
                1 + (int)(rng.NextDouble() * 3)
            ));
        }
    }

    private void OnClusterTap(ClusterTapEventArgs args)
    {
        // args.PointCount, args.Weight, args.Position
    }

    private void OnNoiseTap(ClusterTapEventArgs args)
    {
        // Single unclustered point tapped
    }
}</code></pre>
</details>

<AdvancedHereMap @ref="_advMap" Options="@_mapOptions" Height="clamp(250px, 50vh, 500px)">

    @if (_showClusters && _dataPoints.Count > 0)
    {
        <MarkerClusterComponent DataPoints="@_dataPoints" Eps="@_eps" MinWeight="@_minWeight"
            MinZoom="@_clusterMinZoom" MaxZoom="@_clusterMaxZoom"
            ClusterSvgTemplate="@_clusterSvg" NoiseSvgTemplate="@_noiseSvg"
            OnClusterTap="OnClusterTap" OnNoiseTap="OnNoiseTap" />
    }

</AdvancedHereMap>

<div class="mt-3 d-flex gap-3 flex-wrap align-items-center">
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" @bind="_showClusters" />
        <label class="form-check-label">Show Clusters</label>
    </div>

    <div>
        <label>Points: @_dataPoints.Count</label>
        <div class="btn-group ms-1">
            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => GeneratePoints(100))">100</button>
            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => GeneratePoints(500))">500</button>
            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => GeneratePoints(2000))">2000</button>
        </div>
    </div>

    <div>
        <label>Eps (radius): @_eps</label>
        <input type="range" class="form-range" min="16" max="128" step="8"
            @bind="_eps" @bind:event="oninput" @bind:culture="@CultureInfo.InvariantCulture" style="max-width:150px;" />
    </div>

    <div>
        <label>Min Weight: @_minWeight</label>
        <input type="range" class="form-range" min="1" max="10" step="1"
            @bind="_minWeight" @bind:event="oninput" style="max-width:120px;" />
    </div>

    <div>
        <label>MinZoom: @(_clusterMinZoom?.ToString("F0", CultureInfo.InvariantCulture) ?? "none")</label>
        <input type="number" class="form-control form-control-sm" style="max-width:80px;"
            value="@_clusterMinZoom" @onchange="@(e => _clusterMinZoom = double.TryParse(e.Value?.ToString(), out var v) ? v : null)" />
    </div>

    <div>
        <label>MaxZoom: @(_clusterMaxZoom?.ToString("F0", CultureInfo.InvariantCulture) ?? "none")</label>
        <input type="number" class="form-control form-control-sm" style="max-width:80px;"
            value="@_clusterMaxZoom" @onchange="@(e => _clusterMaxZoom = double.TryParse(e.Value?.ToString(), out var v) ? v : null)" />
    </div>
</div>

@if (!string.IsNullOrEmpty(_status))
{
    <div class="mt-3 alert alert-info">@_status</div>
}

@code {
    private AdvancedHereMap? _advMap;
    private bool _showClusters = true;
    private double _eps = 32;
    private int _minWeight = 2;
    private double? _clusterMinZoom;
    private double? _clusterMaxZoom;
    private List<ClusterDataPoint> _dataPoints = new();
    private string? _status;

    private string _clusterSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50'><circle cx='25' cy='25' r='20' fill='{color}' opacity='0.8'/><text x='25' y='30' text-anchor='middle' fill='white' font-size='12'>{count}</text></svg>";
    private string _noiseSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='6' fill='#4285F4' stroke='white' stroke-width='2'/></svg>";

    private MapOptions _mapOptions = new()
    {
        Center = new LatLngLiteral(51.0, 10.0),
        Zoom = 6,
        EnableUI = true,
        EnableInteraction = true
    };

    protected override void OnInitialized()
    {
        GeneratePoints(500);
    }

    private void GeneratePoints(int count)
    {
        var rng = new Random(42);
        _dataPoints = new List<ClusterDataPoint>();

        // Generate points across Germany
        for (int i = 0; i < count; i++)
        {
            _dataPoints.Add(new ClusterDataPoint(
                47.3 + rng.NextDouble() * 7.5,   // lat: ~47.3 to 54.8
                6.0 + rng.NextDouble() * 9.0,     // lng: ~6.0 to 15.0
                1 + (int)(rng.NextDouble() * 3)
            ));
        }

        _status = $"Generated {count} points across Germany.";
    }

    private void OnClusterTap(ClusterTapEventArgs args)
    {
        _status = $"Cluster tapped: {args.PointCount} points, weight {args.Weight} at ({args.Position?.Lat:F3}, {args.Position?.Lng:F3})";
        StateHasChanged();
    }

    private void OnNoiseTap(ClusterTapEventArgs args)
    {
        _status = $"Single point tapped at ({args.Position?.Lat:F3}, {args.Position?.Lng:F3})";
        StateHasChanged();
    }
}
