@page "/map-geocoding"
@rendermode InteractiveServer
@using HerePlatformComponents.Maps.Events
@using HerePlatformComponents.Maps.Services
@using HerePlatformComponents.Maps.Services.Geocoding
@using HerePlatformComponents.Maps.Services.Places

<PageTitle>Geocoding & Places</PageTitle>

<h3>Geocoding & Places Demo</h3>
<p>Search for places (forward geocoding), click the map (reverse geocoding), or use the Places API.</p>

<details class="mb-3">
    <summary class="fw-bold" role="button">Usage</summary>
    <pre class="bg-light border rounded p-3 mt-2 mb-0"><code>@@inject IGeocodingService GeocodingService

// Forward geocoding
var result = await GeocodingService.GeocodeAsync(
    "Brandenburger Tor, Berlin",
    new GeocodeOptions { Limit = 5 });

foreach (var item in result.Items)
{
    Console.WriteLine($"{item.Title}: {item.Position}");
}

// Reverse geocoding
var reverse = await GeocodingService.ReverseGeocodeAsync(
    new LatLngLiteral(52.5163, 13.3777),
    new GeocodeOptions { Limit = 3 });</code></pre>
</details>

<AdvancedHereMap @ref="_advMap" Options="@_mapOptions" Height="500px"
    OnClick="@OnMapClick">

    @foreach (var item in _markers)
    {
        <MarkerComponent Lat="@item.Position!.Value.Lat" Lng="@item.Position!.Value.Lng">
            <ChildContent>
                <div>
                    <strong>@item.Title</strong>
                    @if (!string.IsNullOrEmpty(item.Address))
                    {
                        <br />@item.Address
                    }
                    @if (!string.IsNullOrEmpty(item.ResultType))
                    {
                        <br /><em>@item.ResultType</em>
                    }
                </div>
            </ChildContent>
        </MarkerComponent>
    }

</AdvancedHereMap>

<div class="mt-3 d-flex gap-3 flex-wrap align-items-end">
    <div>
        <h5>Forward Geocoding</h5>
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search address or place..."
                @bind="_searchQuery" @bind:event="oninput"
                @onkeydown="@(async e => { if (e.Key == "Enter") await SearchForward(); })" />
            <button class="btn btn-primary" @onclick="SearchForward" disabled="@_isSearching">Search</button>
        </div>
    </div>

    <div>
        <h5>Reverse Geocoding</h5>
        <p class="text-muted mb-0" style="font-size: 0.85em;">Click the map to reverse-geocode a position.</p>
    </div>

    <div>
        <button class="btn btn-sm btn-outline-danger" @onclick="ClearResults">Clear</button>
    </div>
</div>

<div class="mt-3 d-flex gap-3 flex-wrap align-items-end">
    <div>
        <h5>Places API â€” Discover</h5>
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search places..."
                @bind="_placesQuery" @bind:event="oninput"
                @onkeydown="@(async e => { if (e.Key == "Enter") await DiscoverPlaces(); })" />
            <button class="btn btn-success" @onclick="DiscoverPlaces" disabled="@_isSearching">Discover</button>
        </div>
    </div>

    <div>
        <h5>Browse by Category</h5>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-success" @onclick="@(() => BrowsePlaces("100-1000-0000"))">Restaurants</button>
            <button class="btn btn-sm btn-outline-success" @onclick="@(() => BrowsePlaces("550-5510-0000"))">Gas Stations</button>
            <button class="btn btn-sm btn-outline-success" @onclick="@(() => BrowsePlaces("300-3000-0000"))">Sights</button>
        </div>
    </div>
</div>

@if (_isSearching)
{
    <div class="mt-3 alert alert-info">Searching...</div>
}

@if (_results.Count > 0)
{
    <div class="mt-3">
        <h5>Results (@_results.Count)</h5>
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Address</th>
                    <th>Type</th>
                    <th>Position</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in _results)
                {
                    <tr @onclick="@(() => FocusResult(item))" style="cursor:pointer;">
                        <td>@item.Title</td>
                        <td>@item.Address</td>
                        <td>@item.ResultType</td>
                        <td>
                            @if (item.Position.HasValue)
                            {
                                @($"{item.Position.Value.Lat:F5}, {item.Position.Value.Lng:F5}")
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@if (_placesResults.Count > 0)
{
    <div class="mt-3">
        <h5>Places Results (@_placesResults.Count)</h5>
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Address</th>
                    <th>Categories</th>
                    <th>Distance</th>
                    <th>Place ID</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in _placesResults)
                {
                    <tr @onclick="@(() => FocusPlace(item))" style="cursor:pointer;">
                        <td>@item.Title</td>
                        <td>@item.Address</td>
                        <td>@(item.Categories != null ? string.Join(", ", item.Categories) : "")</td>
                        <td>@(item.Distance.HasValue ? $"{item.Distance}m" : "")</td>
                        <td style="font-size:0.75em;">@item.PlaceId</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@if (!string.IsNullOrEmpty(_status))
{
    <div class="mt-3 alert alert-warning">@_status</div>
}

@code {
    private AdvancedHereMap? _advMap;
    private string _searchQuery = "";
    private string _placesQuery = "";
    private bool _isSearching;
    private string? _status;
    private List<GeocodeItem> _results = new();
    private List<GeocodeItem> _markers = new();
    private List<PlaceItem> _placesResults = new();

    [Inject]
    private IGeocodingService GeocodingService { get; set; } = default!;

    [Inject]
    private IPlacesService PlacesService { get; set; } = default!;

    private MapOptions _mapOptions = new()
    {
        Center = new LatLngLiteral(52.52, 13.405),
        Zoom = 10,
        EnableUI = true,
        EnableInteraction = true
    };

    private async Task SearchForward()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery)) return;

        _isSearching = true;
        _status = null;
        StateHasChanged();

        try
        {
            var result = await GeocodingService.GeocodeAsync(_searchQuery, new GeocodeOptions { Limit = 10 });
            _results = result.Items ?? new List<GeocodeItem>();
            _markers = _results.Where(i => i.Position.HasValue).ToList();

            if (_results.Count == 0)
            {
                _status = "No results found.";
            }
            else if (_markers.Count > 0)
            {
                // Pan to first result
                var first = _markers[0].Position!.Value;
                if (_advMap?.InteropObject != null)
                {
                    await _advMap.InteropObject.SetCenter(first, true);
                    await _advMap.InteropObject.SetZoom(14, true);
                }
            }
        }
        catch (Exception ex)
        {
            _status = $"Error: {ex.Message}";
        }
        finally
        {
            _isSearching = false;
        }
    }

    private async Task OnMapClick(MapPointerEventArgs e)
    {
        if (!e.Position.HasValue) return;

        _isSearching = true;
        _status = null;
        StateHasChanged();

        try
        {
            var position = e.Position.Value;
            var result = await GeocodingService.ReverseGeocodeAsync(position, new GeocodeOptions { Limit = 5 });
            _results = result.Items ?? new List<GeocodeItem>();
            _markers = _results.Where(i => i.Position.HasValue).ToList();

            if (_results.Count == 0)
            {
                _status = $"No results for position ({position.Lat:F5}, {position.Lng:F5}).";
            }
        }
        catch (Exception ex)
        {
            _status = $"Error: {ex.Message}";
        }
        finally
        {
            _isSearching = false;
        }
    }

    private async Task FocusResult(GeocodeItem item)
    {
        if (!item.Position.HasValue || _advMap?.InteropObject == null) return;
        await _advMap.InteropObject.SetCenter(item.Position.Value, true);
        await _advMap.InteropObject.SetZoom(16, true);
    }

    private async Task DiscoverPlaces()
    {
        if (string.IsNullOrWhiteSpace(_placesQuery)) return;

        _isSearching = true;
        _status = null;
        StateHasChanged();

        try
        {
            var request = new PlacesRequest
            {
                Query = _placesQuery,
                At = _mapOptions.Center,
                Limit = 10
            };
            var result = await PlacesService.DiscoverAsync(request);
            _placesResults = result.Items ?? new List<PlaceItem>();
            _markers = _placesResults.Where(i => i.Position.HasValue)
                .Select(i => new GeocodeItem
                {
                    Title = i.Title,
                    Position = i.Position,
                    Address = i.Address
                }).ToList();

            if (_placesResults.Count == 0) _status = "No places found.";
        }
        catch (Exception ex) { _status = $"Error: {ex.Message}"; }
        finally { _isSearching = false; }
    }

    private async Task BrowsePlaces(string categoryId)
    {
        _isSearching = true;
        _status = null;
        StateHasChanged();

        try
        {
            var request = new PlacesRequest
            {
                At = _mapOptions.Center,
                Categories = new List<string> { categoryId },
                Limit = 10
            };
            var result = await PlacesService.BrowseAsync(request);
            _placesResults = result.Items ?? new List<PlaceItem>();
            _markers = _placesResults.Where(i => i.Position.HasValue)
                .Select(i => new GeocodeItem
                {
                    Title = i.Title,
                    Position = i.Position,
                    Address = i.Address
                }).ToList();

            if (_placesResults.Count == 0) _status = "No places found.";
        }
        catch (Exception ex) { _status = $"Error: {ex.Message}"; }
        finally { _isSearching = false; }
    }

    private async Task FocusPlace(PlaceItem item)
    {
        if (!item.Position.HasValue || _advMap?.InteropObject == null) return;
        await _advMap.InteropObject.SetCenter(item.Position.Value, true);
        await _advMap.InteropObject.SetZoom(16, true);
    }

    private void ClearResults()
    {
        _results.Clear();
        _markers.Clear();
        _placesResults.Clear();
        _status = null;
        _searchQuery = "";
        _placesQuery = "";
    }
}
