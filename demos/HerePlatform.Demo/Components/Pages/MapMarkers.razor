@page "/map-markers"
@rendermode InteractiveServer
@using HerePlatformComponents.Maps.Events

<PageTitle>Markers</PageTitle>

<h3>Markers Demo</h3>
<p>Demonstrates adding, clicking, and dragging markers on the map. The two landmark markers use <code>ChildContent</code> to show an InfoBubble on click (static HTML, no Blazor interactivity in the bubble).</p>

<details class="mb-3">
    <summary class="fw-bold" role="button">Usage</summary>
    <pre class="bg-light border rounded p-3 mt-2 mb-0"><code>&lt;!-- Marker with auto-InfoBubble via ChildContent --&gt;
&lt;MarkerComponent Lat="52.5163" Lng="13.3777"&gt;
    &lt;div style="padding:8px"&gt;
        &lt;strong&gt;Brandenburg Gate&lt;/strong&gt;
        &lt;p&gt;Built 1788–1791&lt;/p&gt;
    &lt;/div&gt;
&lt;/MarkerComponent&gt;

&lt;!-- Clickable marker with event callback --&gt;
&lt;MarkerComponent Lat="52.52" Lng="13.405"
                 Clickable="true"
                 OnClick="@@OnMarkerClicked" /&gt;

&lt;!-- Draggable marker --&gt;
&lt;MarkerComponent Lat="52.52" Lng="13.41"
                 Draggable="true"
                 OnDragEnd="@@OnMarkerDragged" /&gt;

&lt;!-- Two-way binding: drag updates variables, changing variables moves the pin --&gt;
&lt;MarkerComponent @@bind-Lat="_lat" @@bind-Lng="_lng"
                 Draggable="true" /&gt;</code></pre>
</details>

<AdvancedHereMap @ref="_advMap"
                 Options="@_mapOptions"
                 OnAfterInit="@OnMapInit"
                 Height="500px">

    @* Static markers with ChildContent — click to open an auto-InfoBubble *@
    <MarkerComponent Lat="52.5163" Lng="13.3777">
        <div style="padding:8px">
            <strong>Brandenburg Gate</strong>
            <p style="margin:4px 0">Built 1788–1791. One of Berlin's most famous landmarks.</p>
        </div>
    </MarkerComponent>

    <MarkerComponent Lat="52.5219" Lng="13.4132">
        <div style="padding:8px">
            <strong>Alexanderplatz</strong>
            <p style="margin:4px 0">Major public square and transport hub. Home of the TV Tower.</p>
        </div>
    </MarkerComponent>

    @* Two-way bound marker: drag updates _boundLat/_boundLng, changing values moves the pin *@
    <MarkerComponent @bind-Lat="_boundLat" @bind-Lng="_boundLng"
                     Draggable="true" />

    @* Dynamic markers with event callbacks *@
    @foreach (var marker in _markers)
    {
        <MarkerComponent Lat="@marker.Lat"
                         Lng="@marker.Lng"
                         Clickable="true"
                         Draggable="@marker.Draggable"
                         Title="@marker.Title"
                         Visible="true"
                         OnClick="@(e => OnMarkerClicked(marker, e))"
                         OnDragEnd="@(e => OnMarkerDragged(marker, e))" />
    }
</AdvancedHereMap>

<div class="row mt-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header fw-bold">Two-Way Binding</div>
            <div class="card-body">
                <p class="card-text small text-muted">Drag the orange marker or change the coordinates below. Both stay in sync via <code>@@bind-Lat</code> / <code>@@bind-Lng</code>.</p>
                <div class="row g-2">
                    <div class="col">
                        <label class="form-label">Lat</label>
                        <input type="number" step="0.0001" class="form-control form-control-sm"
                               @bind="_boundLat" @bind:event="oninput" />
                    </div>
                    <div class="col">
                        <label class="form-label">Lng</label>
                        <input type="number" step="0.0001" class="form-control form-control-sm"
                               @bind="_boundLng" @bind:event="oninput" />
                    </div>
                    <div class="col-auto d-flex align-items-end">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="ResetBoundMarker">Reset</button>
                    </div>
                </div>
                <small class="text-muted mt-1 d-block">Position: @_boundLat.ToString("F5"), @_boundLng.ToString("F5")</small>
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <button class="btn btn-primary" @onclick="AddMarkerAtCenter">Add Marker at Center</button>
    <button class="btn btn-warning" @onclick="AddDraggableMarker">Add Draggable Marker</button>
    <button class="btn btn-danger" @onclick="ClearMarkers">Clear All</button>
    <span class="ms-3 badge bg-info">Marker count: @_markers.Count</span>
</div>

@if (!string.IsNullOrEmpty(_lastEvent))
{
    <div class="mt-3 alert alert-info">
        @_lastEvent
    </div>
}

@code {
    private AdvancedHereMap? _advMap;
    private List<MarkerInfo> _markers = new();
    private string? _lastEvent;
    private int _markerIndex;
    private double _boundLat = 52.5200;
    private double _boundLng = 13.4050;

    private MapOptions _mapOptions = new()
    {
        Center = new LatLngLiteral(52.52, 13.405),
        Zoom = 13,
        EnableUI = true,
        EnableInteraction = true
    };

    private void OnMapInit()
    {
        // Add initial markers (offset from center to avoid overlap with UI)
        _markers.Add(new MarkerInfo(52.5163, 13.3777, "Victory Column", false));
        _markers.Add(new MarkerInfo(52.5145, 13.3500, "Charlottenburg Palace", false));
        _markers.Add(new MarkerInfo(52.5075, 13.3903, "Potsdamer Platz", false));
        _markerIndex = 3;
        StateHasChanged();
    }

    private void AddMarkerAtCenter()
    {
        _markerIndex++;
        _markers.Add(new MarkerInfo(52.52 + Random.Shared.NextDouble() * 0.01 - 0.005,
            13.405 + Random.Shared.NextDouble() * 0.01 - 0.005,
            $"Marker #{_markerIndex}", false));
        StateHasChanged();
    }

    private void AddDraggableMarker()
    {
        _markerIndex++;
        _markers.Add(new MarkerInfo(
            52.52 + Random.Shared.NextDouble() * 0.008 - 0.004,
            13.405 + Random.Shared.NextDouble() * 0.008 - 0.004,
            $"Draggable #{_markerIndex}", true));
        _lastEvent = $"Added draggable marker #{_markerIndex}. Drag it to see position updates.";
        StateHasChanged();
    }

    private void ResetBoundMarker()
    {
        _boundLat = 52.5200;
        _boundLng = 13.4050;
    }

    private void ClearMarkers()
    {
        _markers.Clear();
        _lastEvent = "All markers cleared.";
        StateHasChanged();
    }

    private void OnMarkerClicked(MarkerInfo marker, MapPointerEventArgs e)
    {
        _lastEvent = $"Clicked: {marker.Title} at ({marker.Lat:F4}, {marker.Lng:F4})" +
            (e.Position.HasValue ? $" — pointer at ({e.Position.Value.Lat:F4}, {e.Position.Value.Lng:F4})" : "");
        StateHasChanged();
    }

    private void OnMarkerDragged(MarkerInfo marker, MapDragEventArgs e)
    {
        if (e.Position.HasValue)
        {
            marker.Lat = e.Position.Value.Lat;
            marker.Lng = e.Position.Value.Lng;
        }
        _lastEvent = $"Dragged: {marker.Title} to ({marker.Lat:F4}, {marker.Lng:F4})";
        StateHasChanged();
    }

    private class MarkerInfo
    {
        public double Lat { get; set; }
        public double Lng { get; set; }
        public string Title { get; set; }
        public bool Draggable { get; set; }

        public MarkerInfo(double lat, double lng, string title, bool draggable)
        {
            Lat = lat;
            Lng = lng;
            Title = title;
            Draggable = draggable;
        }
    }
}
