@page "/map-routing"
@rendermode InteractiveServer
@using HerePlatformComponents.Maps.Events
@using HerePlatformComponents.Maps.Services
@using HerePlatformComponents.Maps.Services.Routing
@using HerePlatformComponents.Maps.Services.Isoline

<PageTitle>Routing</PageTitle>

<h3>Routing Demo</h3>
<p>Click two points on the map to calculate a route, use presets, try isoline, enable turn-by-turn instructions, or configure truck/EV parameters.</p>

<details class="mb-3">
    <summary class="fw-bold" role="button">Usage</summary>
    <pre class="bg-light border rounded p-3 mt-2 mb-0"><code>@@inject IRoutingService RoutingService

var request = new RoutingRequest
{
    Origin = new LatLngLiteral(52.52, 13.405),
    Destination = new LatLngLiteral(48.8566, 2.3522),
    TransportMode = TransportMode.Car,
    ReturnPolyline = true
};

var result = await RoutingService.CalculateRouteAsync(request);

// Display route on map
&lt;AdvancedHereMap Options="@@_mapOptions" Height="500px"&gt;
    &lt;PolylineComponent Path="@@_routePath"
        StrokeColor="#0066FF" LineWidth="5" /&gt;
&lt;/AdvancedHereMap&gt;</code></pre>
</details>

<AdvancedHereMap @ref="_advMap" Options="@_mapOptions" Height="500px"
    OnClick="@OnMapClick">

    @if (_origin.HasValue)
    {
        <MarkerComponent Lat="@_origin.Value.Lat" Lng="@_origin.Value.Lng" />
    }

    @if (_destination.HasValue)
    {
        <MarkerComponent Lat="@_destination.Value.Lat" Lng="@_destination.Value.Lng" />
    }

    @if (_routePath != null && _routePath.Count > 0)
    {
        <PolylineComponent Path="@_routePath" StrokeColor="@_strokeColor"
            LineWidth="5" Visible="true" />
    }

    @if (_isolinePaths != null)
    {
        @foreach (var iso in _isolinePaths)
        {
            <PolygonComponent Path="@iso.Points" FillColor="@iso.Color" StrokeColor="@iso.StrokeColor"
                LineWidth="2" />
        }
    }

</AdvancedHereMap>

<div class="mt-3 d-flex gap-3 flex-wrap">
    <div>
        <h5>Transport Mode</h5>
        <div class="btn-group">
            <button class="btn btn-sm @(_transportMode == TransportMode.Car ? "btn-primary" : "btn-outline-primary")"
                @onclick="@(() => SetTransportMode(TransportMode.Car))">Car</button>
            <button class="btn btn-sm @(_transportMode == TransportMode.Pedestrian ? "btn-primary" : "btn-outline-primary")"
                @onclick="@(() => SetTransportMode(TransportMode.Pedestrian))">Pedestrian</button>
            <button class="btn btn-sm @(_transportMode == TransportMode.Bicycle ? "btn-primary" : "btn-outline-primary")"
                @onclick="@(() => SetTransportMode(TransportMode.Bicycle))">Bicycle</button>
            <button class="btn btn-sm @(_transportMode == TransportMode.Truck ? "btn-primary" : "btn-outline-primary")"
                @onclick="@(() => SetTransportMode(TransportMode.Truck))">Truck</button>
            <button class="btn btn-sm @(_isEvMode ? "btn-success" : "btn-outline-success")"
                @onclick="ToggleEvMode">EV</button>
        </div>
    </div>

    <div>
        <h5>Presets</h5>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" @onclick="PresetBerlinParis">Berlin → Paris</button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="PresetBerlinMunich">Berlin → Munich</button>
        </div>
    </div>

    <div>
        <button class="btn btn-sm btn-outline-danger" @onclick="ClearRoute">Clear</button>
    </div>
</div>

<div class="mt-3 d-flex gap-3 flex-wrap align-items-end">
    <div>
        <h5>Turn-by-Turn</h5>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" @bind="_showInstructions" @bind:after="RecalculateIfReady" />
            <label class="form-check-label">Show Instructions</label>
        </div>
    </div>

    <div>
        <h5>Isoline (Isochrone)</h5>
        <div class="input-group input-group-sm" style="max-width:260px;">
            <span class="input-group-text">Range (min)</span>
            <input type="number" class="form-control" @bind="_isolineMinutes" min="1" max="120" />
            <button class="btn btn-outline-info" @onclick="CalculateIsoline">Calculate</button>
        </div>
        <p class="text-muted mb-0" style="font-size:0.8em;">Uses first click (origin) as center.</p>
    </div>

    @if (_transportMode == TransportMode.Truck)
    {
        <div>
            <h5>Truck Parameters</h5>
            <div class="d-flex gap-2 flex-wrap" style="font-size:0.85em;">
                <div>
                    <label>Height (m)</label>
                    <input type="number" class="form-control form-control-sm" @bind="_truckHeight" step="0.1" @bind:culture="@CultureInfo.InvariantCulture" style="width:80px;" />
                </div>
                <div>
                    <label>Width (m)</label>
                    <input type="number" class="form-control form-control-sm" @bind="_truckWidth" step="0.1" @bind:culture="@CultureInfo.InvariantCulture" style="width:80px;" />
                </div>
                <div>
                    <label>Weight (kg)</label>
                    <input type="number" class="form-control form-control-sm" @bind="_truckWeight" step="1000" style="width:100px;" />
                </div>
            </div>
        </div>
    }

    @if (_isEvMode)
    {
        <div>
            <h5>EV Parameters</h5>
            <div class="d-flex gap-2 flex-wrap" style="font-size:0.85em;">
                <div>
                    <label>Initial Charge (kWh)</label>
                    <input type="number" class="form-control form-control-sm" @bind="_evInitialCharge" step="1" @bind:culture="@CultureInfo.InvariantCulture" style="width:110px;" />
                </div>
                <div>
                    <label>Max Charge (kWh)</label>
                    <input type="number" class="form-control form-control-sm" @bind="_evMaxCharge" step="1" @bind:culture="@CultureInfo.InvariantCulture" style="width:110px;" />
                </div>
                <div>
                    <label>Min at Dest (kWh)</label>
                    <input type="number" class="form-control form-control-sm" @bind="_evMinChargeAtDest" step="1" @bind:culture="@CultureInfo.InvariantCulture" style="width:110px;" />
                </div>
                <div>
                    <label>Aux Power (kW)</label>
                    <input type="number" class="form-control form-control-sm" @bind="_evAuxConsumption" step="0.1" @bind:culture="@CultureInfo.InvariantCulture" style="width:100px;" />
                </div>
            </div>
            <div class="mt-1" style="font-size:0.85em;">
                <label>Speed Table</label>
                <input type="text" class="form-control form-control-sm" @bind="_evFreeFlowSpeedTable"
                    placeholder="0,0.239,27,0.239,45,0.259,..." style="max-width:400px;" />
                <p class="text-muted mb-0" style="font-size:0.8em;">speed(km/h),consumption(kWh/km) pairs</p>
            </div>
        </div>
    }
</div>

@if (_isCalculating)
{
    <div class="mt-3 alert alert-info">Calculating route...</div>
}

@if (_routeSummary != null)
{
    <div class="mt-3 alert alert-success">
        <strong>Route Summary:</strong>
        Distance: @((_routeSummary.Length / 1000.0).ToString("F1", CultureInfo.InvariantCulture)) km |
        Duration: @FormatDuration(_routeSummary.Duration)
        @if (_routeSummary.BaseDuration.HasValue)
        {
            <span> | Base duration: @FormatDuration(_routeSummary.BaseDuration.Value)</span>
        }
    </div>
}

@if (_turnInstructions != null && _turnInstructions.Count > 0)
{
    <div class="mt-3">
        <h5>Turn-by-Turn Instructions</h5>
        <div style="max-height:200px;overflow-y:auto;">
            <ol class="list-group list-group-numbered">
                @foreach (var instr in _turnInstructions)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-start py-1">
                        <div class="ms-2 me-auto">
                            <span class="badge bg-secondary me-1">@instr.Action</span>
                            @(instr.Instruction ?? "")
                        </div>
                        <span class="badge bg-primary rounded-pill">@(instr.Length)m</span>
                    </li>
                }
            </ol>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(_status))
{
    <div class="mt-3 alert alert-info">@_status</div>
}

@code {
    private AdvancedHereMap? _advMap;
    private LatLngLiteral? _origin;
    private LatLngLiteral? _destination;
    private List<LatLngLiteral>? _routePath;
    private RouteSummary? _routeSummary;
    private TransportMode _transportMode = TransportMode.Car;
    private string _strokeColor = "#0066FF";
    private bool _isCalculating;
    private string? _status;
    private bool _showInstructions;
    private List<TurnInstruction>? _turnInstructions;
    private int _isolineMinutes = 10;
    private List<IsolineDisplay>? _isolinePaths;

    // Truck parameters
    private double _truckHeight = 4.0;
    private double _truckWidth = 2.5;
    private int _truckWeight = 36000;

    // EV parameters
    private bool _isEvMode;
    private double _evInitialCharge = 48;
    private double _evMaxCharge = 64;
    private double _evMinChargeAtDest = 6;
    private double _evAuxConsumption = 1.6;
    private string _evFreeFlowSpeedTable = "0,0.239,27,0.239,45,0.259,60,0.196,85,0.238,100,0.26,120,0.318,140,0.388";

    [Inject]
    private IRoutingService RoutingService { get; set; } = default!;

    [Inject]
    private IIsolineService IsolineService { get; set; } = default!;

    private record IsolineDisplay(List<LatLngLiteral> Points, string Color, string StrokeColor);

    private MapOptions _mapOptions = new()
    {
        Center = new LatLngLiteral(51.0, 10.0),
        Zoom = 6,
        EnableUI = true,
        EnableInteraction = true
    };

    private async Task OnMapClick(MapPointerEventArgs e)
    {
        if (!e.Position.HasValue) return;

        if (!_origin.HasValue)
        {
            _origin = e.Position.Value;
            _status = "Origin set. Click another point for destination.";
        }
        else if (!_destination.HasValue)
        {
            _destination = e.Position.Value;
            _status = null;
            await CalculateRoute();
        }
    }

    private async Task ToggleEvMode()
    {
        _isEvMode = !_isEvMode;
        if (_isEvMode && _transportMode != TransportMode.Car)
        {
            _transportMode = TransportMode.Car;
            _strokeColor = "#00AA44";
        }
        _strokeColor = _isEvMode ? "#00AA44" : (_transportMode switch
        {
            TransportMode.Car => "#0066FF",
            TransportMode.Pedestrian => "#FF6600",
            TransportMode.Bicycle => "#00CC00",
            TransportMode.Truck => "#CC0000",
            _ => "#0066FF"
        });

        if (_origin.HasValue && _destination.HasValue)
            await CalculateRoute();
    }

    private async Task SetTransportMode(TransportMode mode)
    {
        _transportMode = mode;
        _isEvMode = false;
        _strokeColor = mode switch
        {
            TransportMode.Car => "#0066FF",
            TransportMode.Pedestrian => "#FF6600",
            TransportMode.Bicycle => "#00CC00",
            TransportMode.Truck => "#CC0000",
            _ => "#0066FF"
        };

        if (_origin.HasValue && _destination.HasValue)
        {
            await CalculateRoute();
        }
    }

    private async Task PresetBerlinParis()
    {
        _origin = new LatLngLiteral(52.52, 13.405);
        _destination = new LatLngLiteral(48.8566, 2.3522);
        await CalculateRoute();
    }

    private async Task PresetBerlinMunich()
    {
        _origin = new LatLngLiteral(52.52, 13.405);
        _destination = new LatLngLiteral(48.1351, 11.582);
        await CalculateRoute();
    }

    private async Task CalculateRoute()
    {
        if (!_origin.HasValue || !_destination.HasValue) return;

        _isCalculating = true;
        _routePath = null;
        _routeSummary = null;
        _turnInstructions = null;
        StateHasChanged();

        try
        {
            var request = new RoutingRequest
            {
                Origin = _origin.Value,
                Destination = _destination.Value,
                TransportMode = _transportMode,
                ReturnPolyline = true,
                ReturnInstructions = _showInstructions
            };

            // Truck parameters
            if (_transportMode == TransportMode.Truck)
            {
                request.Truck = new TruckOptions
                {
                    Height = _truckHeight,
                    Width = _truckWidth,
                    GrossWeight = _truckWeight
                };
            }

            // EV parameters
            if (_isEvMode)
            {
                request.Ev = new EvOptions
                {
                    InitialCharge = _evInitialCharge,
                    MaxCharge = _evMaxCharge,
                    MinChargeAtDestination = _evMinChargeAtDest,
                    AuxiliaryConsumption = _evAuxConsumption,
                    FreeFlowSpeedTable = _evFreeFlowSpeedTable
                };
            }

            var result = await RoutingService.CalculateRouteAsync(request);

            if (result.Routes is { Count: > 0 })
            {
                var path = new List<LatLngLiteral>();
                var route = result.Routes[0];
                if (route.Sections != null)
                {
                    foreach (var section in route.Sections)
                    {
                        if (section.DecodedPolyline != null)
                            path.AddRange(section.DecodedPolyline);

                        _routeSummary ??= section.Summary;

                        if (section.TurnByTurnActions != null)
                        {
                            _turnInstructions ??= new List<TurnInstruction>();
                            _turnInstructions.AddRange(section.TurnByTurnActions);
                        }
                    }
                }
                _routePath = path;
            }
        }
        catch (Exception ex)
        {
            _status = $"Error: {ex.Message}";
        }
        finally
        {
            _isCalculating = false;
        }
    }

    private async Task CalculateIsoline()
    {
        if (!_origin.HasValue) { _status = "Set an origin first (click the map)."; return; }

        _isCalculating = true;
        _isolinePaths = null;
        StateHasChanged();

        try
        {
            var request = new IsolineRequest
            {
                Center = _origin.Value,
                Ranges = new List<int> { _isolineMinutes * 60 },
                RangeType = IsolineRangeType.Time,
                TransportMode = _transportMode
            };

            var result = await IsolineService.CalculateIsolineAsync(request);

            if (result.Isolines is { Count: > 0 })
            {
                _isolinePaths = new();
                foreach (var iso in result.Isolines)
                {
                    if (iso.Polygon is { Count: > 0 })
                    {
                        _isolinePaths.Add(new IsolineDisplay(iso.Polygon, "rgba(0,102,255,0.2)", "#0066FF"));
                    }
                }
            }
            else
            {
                _status = "No isoline returned.";
            }
        }
        catch (Exception ex)
        {
            _status = $"Error: {ex.Message}";
        }
        finally
        {
            _isCalculating = false;
        }
    }

    private async Task RecalculateIfReady()
    {
        if (_origin.HasValue && _destination.HasValue)
        {
            await CalculateRoute();
        }
    }

    private void ClearRoute()
    {
        _origin = null;
        _destination = null;
        _routePath = null;
        _routeSummary = null;
        _turnInstructions = null;
        _isolinePaths = null;
        _status = "Click on the map to set origin.";
    }

    private string FormatDuration(int seconds)
    {
        var hours = seconds / 3600;
        var mins = (seconds % 3600) / 60;
        return hours > 0 ? $"{hours}h {mins}m" : $"{mins}m";
    }
}
