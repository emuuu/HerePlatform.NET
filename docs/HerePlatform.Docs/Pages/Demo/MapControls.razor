@page "/demo/map-controls"

<PageTitle>Map Controls</PageTitle>

<h3>Map Controls Demo</h3>
<p>Demonstrates programmatic map manipulation: zoom, center, tilt, heading.</p>

<details class="mb-3">
    <summary class="fw-bold" role="button">Usage</summary>
    <pre class="bg-light border rounded p-3 mt-2 mb-0"><code>&lt;HereMap @@ref="_map"
         Options="@@_mapOptions"
         OnAfterInit="@@OnMapInit"
         Height="500px" /&gt;

@@code {
    private HereMap? _map;
    private double _currentZoom = 12;
    private double _currentTilt;
    private double _currentHeading;
    private LatLngLiteral? _currentCenter;
    private bool _trafficLayerAdded;

    private MapOptions _mapOptions = new()
    {
        Center = new LatLngLiteral(52.52, 13.405),
        Zoom = 12,
        EnableUI = true,
        EnableInteraction = true
    };

    private async Task OnMapInit() =&gt; await ReadMapState();

    // Programmatic zoom control
    private async Task ZoomIn()
    {
        if (_map?.InteropObject == null) return;
        _currentZoom = Math.Min(_currentZoom + 1, 20);
        await _map.InteropObject.SetZoom(_currentZoom);
    }

    // Navigate to a specific location
    private async Task GoTo(double lat, double lng, double zoom)
    {
        if (_map?.InteropObject == null) return;
        await _map.InteropObject.SetCenter(new LatLngLiteral(lat, lng));
        await _map.InteropObject.SetZoom(zoom);
    }

    // 3D tilt and heading (rotation)
    private async Task SetTilt(double tilt)
    {
        if (_map?.InteropObject == null) return;
        await _map.InteropObject.SetTilt(tilt);
    }

    private async Task SetHeading(double heading)
    {
        if (_map?.InteropObject == null) return;
        await _map.InteropObject.SetHeading(heading);
    }

    // Constrain zoom range
    private async Task ApplyZoomLimits()
    {
        if (_map?.InteropObject == null) return;
        await _map.InteropObject.SetMinZoom(3);
        await _map.InteropObject.SetMaxZoom(16);
    }

    // Read current map state
    private async Task ReadMapState()
    {
        if (_map?.InteropObject == null) return;
        _currentCenter = await _map.InteropObject.GetCenter();
        _currentZoom = await _map.InteropObject.GetZoom();
        _currentTilt = await _map.InteropObject.GetTilt();
        _currentHeading = await _map.InteropObject.GetHeading();
    }

    // Toggle traffic overlay
    private async Task ToggleTrafficLayer()
    {
        if (_map?.InteropObject == null) return;
        if (_trafficLayerAdded)
            await _map.InteropObject.RemoveLayerAsync("vector.traffic.map");
        else
            await _map.InteropObject.AddLayerAsync("vector.traffic.map");
        _trafficLayerAdded = !_trafficLayerAdded;
    }
}</code></pre>
</details>

<HereMap @ref="_map"
         Options="@_mapOptions"
         OnAfterInit="@OnMapInit"
         Height="clamp(250px, 50vh, 500px)" />

<div class="mt-3">
    <div class="row g-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Zoom</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" @onclick="ZoomIn">Zoom In (+)</button>
                        <button class="btn btn-sm btn-outline-primary" @onclick="ZoomOut">Zoom Out (-)</button>
                    </div>
                    <span class="ms-2 badge bg-secondary">Level: @_currentZoom</span>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Navigate To</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-success" @onclick="() => GoTo(52.52, 13.405, 14)">Berlin</button>
                        <button class="btn btn-sm btn-outline-success" @onclick="() => GoTo(48.8566, 2.3522, 13)">Paris</button>
                        <button class="btn btn-sm btn-outline-success" @onclick="() => GoTo(51.5074, -0.1278, 13)">London</button>
                        <button class="btn btn-sm btn-outline-success" @onclick="() => GoTo(40.7128, -74.006, 12)">New York</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tilt (3D)</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-warning" @onclick="() => SetTilt(0)">0</button>
                        <button class="btn btn-sm btn-outline-warning" @onclick="() => SetTilt(30)">30</button>
                        <button class="btn btn-sm btn-outline-warning" @onclick="() => SetTilt(45)">45</button>
                        <button class="btn btn-sm btn-outline-warning" @onclick="() => SetTilt(60)">60</button>
                    </div>
                    <span class="ms-2 badge bg-secondary">Tilt: @_currentTilt</span>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Heading (Rotation)</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-info" @onclick="() => SetHeading(0)">North</button>
                        <button class="btn btn-sm btn-outline-info" @onclick="() => SetHeading(90)">East</button>
                        <button class="btn btn-sm btn-outline-info" @onclick="() => SetHeading(180)">South</button>
                        <button class="btn btn-sm btn-outline-info" @onclick="() => SetHeading(270)">West</button>
                    </div>
                    <span class="ms-2 badge bg-secondary">Heading: @_currentHeading</span>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Zoom Limits</h5>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <div>
                            <label class="form-label mb-0">Min Zoom: @_minZoom</label>
                            <input type="range" class="form-range" min="1" max="15" step="1"
                                @bind="_minZoom" @bind:event="oninput" @bind:culture="@CultureInfo.InvariantCulture" @bind:after="ApplyMinZoom" style="max-width:120px;" />
                        </div>
                        <div>
                            <label class="form-label mb-0">Max Zoom: @_maxZoom</label>
                            <input type="range" class="form-range" min="5" max="20" step="1"
                                @bind="_maxZoom" @bind:event="oninput" @bind:culture="@CultureInfo.InvariantCulture" @bind:after="ApplyMaxZoom" style="max-width:120px;" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Traffic Layer</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm @(_trafficLayerAdded ? "btn-success" : "btn-outline-success")" @onclick="ToggleTrafficLayer">
                            Traffic @(_trafficLayerAdded ? "ON" : "OFF")
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Current Position</h5>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ReadMapState">Refresh State</button>
                    @if (_currentCenter.HasValue)
                    {
                        <span class="ms-2">
                            Center: @_currentCenter.Value.Lat.ToString("F4", CultureInfo.InvariantCulture), @_currentCenter.Value.Lng.ToString("F4", CultureInfo.InvariantCulture)
                        </span>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private HereMap? _map;
    private double _currentZoom = 12;
    private double _currentTilt;
    private double _currentHeading;
    private LatLngLiteral? _currentCenter;
    private double _minZoom = 1;
    private double _maxZoom = 20;
    private bool _trafficLayerAdded;

    private MapOptions _mapOptions = new()
    {
        Center = new LatLngLiteral(52.52, 13.405),
        Zoom = 12,
        EnableUI = true,
        EnableInteraction = true
    };

    private async Task OnMapInit()
    {
        await ReadMapState();
    }

    private async Task ZoomIn()
    {
        if (_map?.InteropObject == null) return;
        _currentZoom = Math.Min(_currentZoom + 1, 20);
        await _map.InteropObject.SetZoom(_currentZoom);
    }

    private async Task ZoomOut()
    {
        if (_map?.InteropObject == null) return;
        _currentZoom = Math.Max(_currentZoom - 1, 1);
        await _map.InteropObject.SetZoom(_currentZoom);
    }

    private async Task GoTo(double lat, double lng, double zoom)
    {
        if (_map?.InteropObject == null) return;
        await _map.InteropObject.SetCenter(new LatLngLiteral(lat, lng));
        await _map.InteropObject.SetZoom(zoom);
        _currentZoom = zoom;
        await ReadMapState();
    }

    private async Task SetTilt(double tilt)
    {
        if (_map?.InteropObject == null) return;
        await _map.InteropObject.SetTilt(tilt);
        _currentTilt = tilt;
    }

    private async Task SetHeading(double heading)
    {
        if (_map?.InteropObject == null) return;
        await _map.InteropObject.SetHeading(heading);
        _currentHeading = heading;
    }

    private async Task ReadMapState()
    {
        if (_map?.InteropObject == null) return;
        _currentCenter = await _map.InteropObject.GetCenter();
        _currentZoom = await _map.InteropObject.GetZoom();
        _currentTilt = await _map.InteropObject.GetTilt();
        _currentHeading = await _map.InteropObject.GetHeading();
        StateHasChanged();
    }

    private async Task ApplyMinZoom()
    {
        if (_map?.InteropObject == null) return;
        await _map.InteropObject.SetMinZoom(_minZoom);
    }

    private async Task ApplyMaxZoom()
    {
        if (_map?.InteropObject == null) return;
        await _map.InteropObject.SetMaxZoom(_maxZoom);
    }

    private async Task ToggleTrafficLayer()
    {
        if (_map?.InteropObject == null) return;
        if (_trafficLayerAdded)
        {
            await _map.InteropObject.RemoveLayerAsync("vector.traffic.map");
            _trafficLayerAdded = false;
        }
        else
        {
            await _map.InteropObject.AddLayerAsync("vector.traffic.map");
            _trafficLayerAdded = true;
        }
    }
}
