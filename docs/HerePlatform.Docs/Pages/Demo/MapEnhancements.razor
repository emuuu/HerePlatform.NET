@page "/demo/map-enhancements"

<PageTitle>Map Enhancements</PageTitle>

<h3>Map Enhancements Demo</h3>
<p>Animated transitions, behavior control, polygon with holes, 3D extrusion, map capture, image overlay, zoom to bounds, and context menu.</p>

<details class="mb-3">
    <summary class="fw-bold" role="button">Usage</summary>
    <pre class="bg-light border rounded p-3 mt-2 mb-0"><code>@@using HerePlatformComponents.Maps.Events

&lt;!-- Animate enables smooth transitions when Center/Zoom change.
     DisabledBehaviors selectively disables Panning, WheelZoom, etc.
     bind-Center/Zoom/Tilt enables two-way binding with the map viewport. --&gt;
&lt;AdvancedHereMap @@ref="_advMap" Options="@@_mapOptions" Height="500px"
    Animate="@@_animate"
    DisabledBehaviors="@@_disabledBehaviors"
    @@bind-Center="_center" @@bind-Zoom="_zoom" @@bind-Tilt="_tilt"&gt;

    &lt;!-- Polygon with a hole cut out --&gt;
    &lt;PolygonComponent Path="@@_polygonPath" Holes="@@_polygonHoles"
        StrokeColor="#00CC00" FillColor="rgba(0, 204, 0, 0.4)"
        LineWidth="2" Clickable="true"
        OnClick="@@(e =&gt; _status = &amp;quot;Polygon clicked&amp;quot;)" /&gt;

    &lt;!-- 3D extruded polygon (tilt the map to see) --&gt;
    &lt;PolygonComponent Path="@@_extrusionPath"
        StrokeColor="#3498DB" FillColor="rgba(52, 152, 219, 0.6)"
        Extrusion="@@_extrusionHeight" Elevation="@@_extrusionElevation" /&gt;

    &lt;!-- Image overlay positioned by geo bounds --&gt;
    &lt;ImageOverlayComponent ImageUrl="@@_imageUrl"
        Top="52.53" Left="13.37" Bottom="52.51" Right="13.43"
        Opacity="0.7" /&gt;

    &lt;!-- Right-click context menu --&gt;
    &lt;ContextMenuComponent OnItemClick="@@OnContextMenuItem"&gt;
        &lt;ContextMenuItem Label="Add Marker Here" /&gt;
        &lt;ContextMenuItem Label="Zoom In" /&gt;
    &lt;/ContextMenuComponent&gt;

&lt;/AdvancedHereMap&gt;

@@code {
    private AdvancedHereMap? _advMap;
    private bool _animate = true;
    private LatLngLiteral _center = new(52.52, 13.405);
    private double _zoom = 13;
    private double _tilt = 0;
    private string? _status;
    private BehaviorFeature _disabledBehaviors;

    private double _extrusionHeight = 100;
    private double _extrusionElevation = 0;

    private MapOptions _mapOptions = new()
    {
        Center = new LatLngLiteral(52.52, 13.405),
        Zoom = 13,
        EnableUI = true,
        EnableInteraction = true
    };

    // Outer ring and hole for polygon
    private List&lt;LatLngLiteral&gt; _polygonPath = new()
    {
        new(52.530, 13.370), new(52.530, 13.400),
        new(52.510, 13.400), new(52.510, 13.370)
    };

    private List&lt;List&lt;LatLngLiteral&gt;&gt; _polygonHoles = new()
    {
        new() { new(52.525, 13.378), new(52.525, 13.392),
                new(52.515, 13.392), new(52.515, 13.378) }
    };

    private List&lt;LatLngLiteral&gt; _extrusionPath = new()
    {
        new(52.522, 13.410), new(52.522, 13.425),
        new(52.515, 13.425), new(52.515, 13.410)
    };

    // Capture map as Base64 PNG image
    private async Task CaptureMap()
    {
        if (_advMap?.InteropObject == null) return;
        var base64 = await _advMap.InteropObject.CaptureAsync();
    }

    // Zoom to fit all child markers
    private async Task ZoomToMarkers()
    {
        if (_advMap != null)
            await _advMap.ZoomToMarkersAsync(_animate);
    }

    private async Task OnContextMenuItem(ContextMenuEventArgs args)
    {
        // args.ItemLabel, args.Position
    }
}</code></pre>
</details>

<AdvancedHereMap @ref="_advMap" Options="@_mapOptions" Height="clamp(250px, 50vh, 500px)"
    Animate="@_animate"
    DisabledBehaviors="@_disabledBehaviors"
    @bind-Center="_center"
    @bind-Zoom="_zoom"
    @bind-Tilt="_tilt">

    <!-- Polygon with hole -->
    @if (_showHolePolygon)
    {
        <PolygonComponent
            Path="@_polygonPath"
            Holes="@(_showHole ? _polygonHoles : null)"
            StrokeColor="#00CC00"
            FillColor="rgba(0, 204, 0, 0.4)"
            LineWidth="2"
            Clickable="true"
            OnClick="@(e => _status = "Polygon with hole clicked")" />
    }

    <!-- 3D Extrusion polygon -->
    @if (_showExtrusionPolygon)
    {
        <PolygonComponent
            Path="@_extrusionPath"
            StrokeColor="#3498DB"
            FillColor="rgba(52, 152, 219, 0.6)"
            LineWidth="2"
            Extrusion="@_extrusionHeight"
            Elevation="@_extrusionElevation" />
    }

    <!-- Markers for Zoom to Bounds demo -->
    @foreach (var pos in _zoomMarkers)
    {
        <MarkerComponent Lat="@pos.Lat" Lng="@pos.Lng" />
    }

    <!-- Image Overlay -->
    @if (_showImageOverlay && !string.IsNullOrEmpty(_imageOverlayUrl))
    {
        <ImageOverlayComponent
            ImageUrl="@_imageOverlayUrl"
            Top="@_overlayTop" Left="@_overlayLeft"
            Bottom="@_overlayBottom" Right="@_overlayRight"
            Opacity="@_overlayOpacity" />
    }

    <!-- Context Menu -->
    <ContextMenuComponent OnItemClick="@OnContextMenuItem">
        <ContextMenuItem Label="Add Marker Here" />
        <ContextMenuItem Label="Zoom In" />
        <ContextMenuItem Label="Reset View" />
    </ContextMenuComponent>

</AdvancedHereMap>

<div class="mt-3 d-flex gap-3 flex-wrap">
    <div>
        <h5>Polygon with Holes</h5>
        <div class="form-check form-switch mb-1">
            <input class="form-check-input" type="checkbox" @bind="_showHolePolygon" />
            <label class="form-check-label">Show Polygon</label>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" @bind="_showHole" />
            <label class="form-check-label">Cut Hole</label>
        </div>
    </div>

    <div>
        <h5>3D Extrusion &amp; Tilt</h5>
        <div class="form-check form-switch mb-1">
            <input class="form-check-input" type="checkbox" @bind="_showExtrusionPolygon" />
            <label class="form-check-label">Show Polygon</label>
        </div>
        <div class="d-flex flex-column gap-1" style="font-size:0.85em;">
            <label>Tilt: @_tilt.ToString("F0", CultureInfo.InvariantCulture)Â°
                <input type="range" min="0" max="70" step="5" @bind="_tilt" @bind:event="oninput" @bind:culture="@CultureInfo.InvariantCulture" style="max-width:120px;" />
            </label>
            <label>Height: @_extrusionHeight.ToString("F0", CultureInfo.InvariantCulture) m
                <input type="range" min="0" max="500" step="10" @bind="_extrusionHeight" @bind:event="oninput" @bind:culture="@CultureInfo.InvariantCulture" style="max-width:120px;" />
            </label>
            <label>Elevation: @_extrusionElevation.ToString("F0", CultureInfo.InvariantCulture) m
                <input type="range" min="0" max="200" step="10" @bind="_extrusionElevation" @bind:event="oninput" @bind:culture="@CultureInfo.InvariantCulture" style="max-width:120px;" />
            </label>
        </div>
        <small class="text-muted">Tilt the map to see 3D extrusions and buildings (HARP engine).</small>
    </div>

    <div>
        <h5>Animated Transitions</h5>
        <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" @bind="_animate" />
            <label class="form-check-label">Animate</label>
        </div>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => _center = new LatLngLiteral(48.8566, 2.3522))">Paris</button>
            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => _center = new LatLngLiteral(52.52, 13.405))">Berlin</button>
            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => _zoom = 16)">Zoom 16</button>
            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => _zoom = 10)">Zoom 10</button>
        </div>
    </div>

    <div>
        <h5>Behavior Control</h5>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" @bind="_disablePanning" @bind:after="UpdateBehaviors" />
            <label class="form-check-label">Disable Panning</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" @bind="_disableWheelZoom" @bind:after="UpdateBehaviors" />
            <label class="form-check-label">Disable Wheel Zoom</label>
        </div>
    </div>

    <div>
        <h5>Capture</h5>
        <button class="btn btn-sm btn-outline-success" @onclick="CaptureMap">Capture Map</button>
    </div>

    <div>
        <h5>Zoom to Bounds</h5>
        <button class="btn btn-sm btn-outline-info" @onclick="AddRandomMarkers">Add Random Markers</button>
        <button class="btn btn-sm btn-outline-info" @onclick="ZoomToMarkers">Zoom to Markers</button>
    </div>
</div>

<div class="mt-3 d-flex gap-3 flex-wrap align-items-end">
    <div>
        <h5>Image Overlay</h5>
        <div class="form-check form-switch mb-1">
            <input class="form-check-input" type="checkbox" @bind="_showImageOverlay" />
            <label class="form-check-label">Show Overlay</label>
        </div>
        <div class="d-flex gap-2 align-items-center" style="font-size:0.85em;">
            <label>Opacity:</label>
            <input type="range" min="0" max="1" step="0.1" @bind="_overlayOpacity" @bind:event="oninput" @bind:culture="@System.Globalization.CultureInfo.InvariantCulture" style="max-width:100px;" />
            <span>@_overlayOpacity.ToString("F1", CultureInfo.InvariantCulture)</span>
        </div>
    </div>

    <div>
        <h5>Context Menu</h5>
        <p class="text-muted mb-0" style="font-size:0.8em;">Right-click the map to see the context menu.</p>
    </div>
</div>

@if (!string.IsNullOrEmpty(_capturedImage))
{
    <div class="mt-3">
        <img src="@_capturedImage" alt="Captured map" style="max-width:400px;border:1px solid #ccc;" />
    </div>
}

@if (!string.IsNullOrEmpty(_status))
{
    <div class="mt-3 alert alert-info">@_status</div>
}

@code {
    private AdvancedHereMap? _advMap;
    private bool _animate = true;
    private LatLngLiteral _center = new(52.52, 13.405);
    private double _zoom = 13;
    private double _tilt = 0;
    private string? _status;
    private string? _capturedImage;

    private bool _disablePanning;
    private bool _disableWheelZoom;
    private BehaviorFeature _disabledBehaviors;

    // Polygon with Holes
    private bool _showHolePolygon = true;
    private bool _showHole = true;

    // 3D Extrusion
    private bool _showExtrusionPolygon = true;
    private double _extrusionHeight = 100;
    private double _extrusionElevation = 0;

    // Zoom to Bounds
    private List<LatLngLiteral> _zoomMarkers = new();

    // Image Overlay
    private bool _showImageOverlay;
    private string _imageOverlayUrl = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect width='200' height='200' fill='rgba(255,0,0,0.3)' stroke='red' stroke-width='4'/%3E%3Ctext x='100' y='110' text-anchor='middle' font-size='24' fill='red'%3EOverlay%3C/text%3E%3C/svg%3E";
    private double _overlayTop = 52.53;
    private double _overlayLeft = 13.37;
    private double _overlayBottom = 52.51;
    private double _overlayRight = 13.43;
    private double _overlayOpacity = 0.7;

    private MapOptions _mapOptions = new()
    {
        Center = new LatLngLiteral(52.52, 13.405),
        Zoom = 13,
        EnableUI = true,
        EnableInteraction = true
    };

    // Outer polygon with a hole
    private List<LatLngLiteral> _polygonPath = new()
    {
        new(52.530, 13.370),
        new(52.530, 13.400),
        new(52.510, 13.400),
        new(52.510, 13.370)
    };

    private List<List<LatLngLiteral>> _polygonHoles = new()
    {
        new()
        {
            new(52.525, 13.378),
            new(52.525, 13.392),
            new(52.515, 13.392),
            new(52.515, 13.378)
        }
    };

    // Extrusion polygon
    private List<LatLngLiteral> _extrusionPath = new()
    {
        new(52.522, 13.410),
        new(52.522, 13.425),
        new(52.515, 13.425),
        new(52.515, 13.410)
    };

    private void UpdateBehaviors()
    {
        _disabledBehaviors = BehaviorFeature.None;
        if (_disablePanning) _disabledBehaviors |= BehaviorFeature.Panning;
        if (_disableWheelZoom) _disabledBehaviors |= BehaviorFeature.WheelZoom;
    }

    private async Task CaptureMap()
    {
        if (_advMap?.InteropObject == null) return;
        _capturedImage = await _advMap.InteropObject.CaptureAsync();
        _status = "Map captured!";
    }

    private void AddRandomMarkers()
    {
        var rnd = new Random();
        _zoomMarkers.Clear();
        for (int i = 0; i < 5; i++)
        {
            _zoomMarkers.Add(new LatLngLiteral(
                52.4 + rnd.NextDouble() * 0.3,
                13.2 + rnd.NextDouble() * 0.4));
        }
        _status = $"Added {_zoomMarkers.Count} markers.";
    }

    private async Task ZoomToMarkers()
    {
        if (_advMap == null || _zoomMarkers.Count == 0)
        {
            _status = "Add markers first.";
            return;
        }
        await _advMap.ZoomToMarkersAsync(_animate);
        _status = "Zoomed to markers.";
    }

    private async Task OnContextMenuItem(ContextMenuEventArgs args)
    {
        switch (args.ItemLabel)
        {
            case "Add Marker Here":
                if (args.Position.HasValue)
                {
                    _zoomMarkers.Add(args.Position.Value);
                    _status = $"Marker added at {args.Position.Value.Lat:F4}, {args.Position.Value.Lng:F4}";
                }
                break;
            case "Zoom In":
                _zoom = Math.Min(_zoom + 2, 20);
                _status = $"Zoomed to {_zoom}";
                break;
            case "Reset View":
                _center = new LatLngLiteral(52.52, 13.405);
                _zoom = 13;
                _status = "View reset.";
                break;
        }
    }
}
