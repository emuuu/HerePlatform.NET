@page "/demo/map-utilities"

<PageTitle>Utilities</PageTitle>

<h3>Utilities Demo</h3>
<p>WKT Parser, GeoJSON Export, Custom Tiles, and Flexible Polyline codec.</p>

<details class="mb-3">
    <summary class="fw-bold" role="button">Usage</summary>
    <pre class="bg-light border rounded p-3 mt-2 mb-0"><code>@@using HerePlatform.Core.Utilities

&lt;AdvancedHereMap Options="@@_mapOptions" Height="400px"&gt;

    &lt;!-- Custom XYZ tile overlay (e.g. OpenTopoMap) --&gt;
    &lt;CustomTileLayerComponent
        UrlPattern="https://tile.opentopomap.org/{z}/{x}/{y}.png"
        Opacity="0.6" /&gt;

&lt;/AdvancedHereMap&gt;

@@code {
    // --- WKT Parsing ---
    // Parse WKT geometry strings into LatLngLiteral collections
    var point = WktParser.ParsePoint("POINT(13.405 52.52)");
    var line = WktParser.ParseLineString(
        "LINESTRING(13.405 52.52, 2.3522 48.8566, -0.1278 51.5074)");
    var rings = WktParser.ParsePolygon(
        "POLYGON((13.35 52.55, 13.45 52.55, 13.45 52.49, 13.35 52.49, 13.35 52.55))");
    var multi = WktParser.ParseMultiPoint(
        "MULTIPOINT(13.405 52.52, 11.582 48.1351)");

    // --- GeoJSON Export ---
    // Convert parsed geometries to GeoJSON strings
    var geoJson = GeoJsonExporter.ToFeatureCollection(new[]
    {
        GeoJsonExporter.ToPolygonFeature(rings[0]),
        GeoJsonExporter.ToLineStringFeature(line),
        GeoJsonExporter.ToGeoJsonFeature(point.Value)
    });

    // --- Flexible Polyline Codec ---
    // Decode HERE-format encoded polylines to coordinates
    var decoded = FlexiblePolyline.Decode("BFoz5xJ67i1B...");
    // Encode coordinates back to compact polyline string
    var encoded = FlexiblePolyline.Encode(decoded);
}</code></pre>
</details>

<AdvancedHereMap @ref="_advMap" Options="@_mapOptions" Height="clamp(250px, 50vh, 400px)">

    @if (_wktPoints != null)
    {
        @foreach (var point in _wktPoints)
        {
            <MarkerComponent Lat="@point.Lat" Lng="@point.Lng" />
        }
    }

    @if (_wktLineString != null && _wktLineString.Count > 0)
    {
        <PolylineComponent Path="@_wktLineString" StrokeColor="#FF0000" LineWidth="3" />
    }

    @if (_wktPolygonRing != null && _wktPolygonRing.Count > 0)
    {
        <PolygonComponent Path="@_wktPolygonRing" StrokeColor="#00AA00" FillColor="rgba(0,170,0,0.25)" LineWidth="2" />
    }

    @if (_showCustomTiles)
    {
        <CustomTileLayerComponent UrlPattern="@_tileUrl" Opacity="0.6" />
    }

</AdvancedHereMap>

<div class="mt-3">
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "wkt" ? "active" : "")"
                @onclick="@(() => _activeTab = "wkt")">WKT Parser</button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "geojson" ? "active" : "")"
                @onclick="@(() => _activeTab = "geojson")">GeoJSON Export</button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "polyline" ? "active" : "")"
                @onclick="@(() => _activeTab = "polyline")">Flexible Polyline</button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "tiles" ? "active" : "")"
                @onclick="@(() => _activeTab = "tiles")">Custom Tiles</button>
        </li>
    </ul>

    <div class="tab-content p-3 border border-top-0">
        @if (_activeTab == "wkt")
        {
            <div>
                <label class="form-label fw-bold">Enter WKT geometry:</label>
                <textarea class="form-control" rows="3" @bind="_wktInput"></textarea>
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary me-2" @onclick="ParseWkt">Parse &amp; Show</button>
                    <span class="text-muted me-2">Presets:</span>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="PresetPoint">Point</button>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="PresetLineString">LineString</button>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="PresetPolygon">Polygon</button>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="PresetMultiPoint">MultiPoint</button>
                    </div>
                </div>
            </div>
        }
        else if (_activeTab == "geojson")
        {
            <div>
                <p class="text-muted">Parse some WKT first, then export the result as GeoJSON.</p>
                <button class="btn btn-sm btn-primary" @onclick="ExportGeoJson">Export as GeoJSON</button>
                @if (!string.IsNullOrEmpty(_geoJsonOutput))
                {
                    <pre class="mt-2 p-2 bg-light border rounded" style="max-height:300px;overflow:auto;">@_geoJsonOutput</pre>
                }
            </div>
        }
        else if (_activeTab == "polyline")
        {
            <div>
                <label class="form-label fw-bold">HERE Flexible Polyline string:</label>
                <input type="text" class="form-control" @bind="_polylineInput" />
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary me-2" @onclick="DecodePolyline">Decode &amp; Show</button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="EncodeCurrentPoints">Encode Current Points</button>
                </div>
                @if (!string.IsNullOrEmpty(_polylineOutput))
                {
                    <pre class="mt-2 p-2 bg-light border rounded">@_polylineOutput</pre>
                }
            </div>
        }
        else if (_activeTab == "tiles")
        {
            <div>
                <p class="text-muted">Overlay a custom XYZ tile layer on the map.</p>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="tileToggle" @bind="_showCustomTiles" />
                    <label class="form-check-label" for="tileToggle">Show OpenTopoMap overlay</label>
                </div>
                <label class="form-label">Tile URL pattern:</label>
                <input type="text" class="form-control form-control-sm" @bind="_tileUrl" />
                <small class="text-muted">Use <code>{z}</code>, <code>{x}</code>, <code>{y}</code> placeholders.</small>
            </div>
        }
    </div>
</div>

@if (!string.IsNullOrEmpty(_status))
{
    <div class="mt-3 alert alert-info">@_status</div>
}

@code {
    private AdvancedHereMap? _advMap;
    private string _activeTab = "wkt";
    private string _wktInput = "POINT(13.405 52.52)";
    private string? _geoJsonOutput;
    private string _polylineInput = "";
    private string? _polylineOutput;
    private string? _status;
    private bool _showCustomTiles;
    private string _tileUrl = "https://tile.opentopomap.org/{z}/{x}/{y}.png";

    private List<LatLngLiteral>? _wktPoints;
    private List<LatLngLiteral>? _wktLineString;
    private List<LatLngLiteral>? _wktPolygonRing;

    private MapOptions _mapOptions = new()
    {
        Center = new LatLngLiteral(52.52, 13.405),
        Zoom = 6,
        EnableUI = true,
        EnableInteraction = true
    };

    private void PresetPoint()
    {
        _wktInput = "POINT(13.405 52.52)";
        ParseWkt();
    }

    private void PresetLineString()
    {
        _wktInput = "LINESTRING(13.405 52.52, 2.3522 48.8566, -0.1278 51.5074)";
        ParseWkt();
    }

    private void PresetPolygon()
    {
        _wktInput = "POLYGON((13.35 52.55, 13.45 52.55, 13.45 52.49, 13.35 52.49, 13.35 52.55))";
        ParseWkt();
    }

    private void PresetMultiPoint()
    {
        _wktInput = "MULTIPOINT(13.405 52.52, 11.582 48.1351, 8.6821 50.1109, 9.9937 53.5511)";
        ParseWkt();
    }

    private void ParseWkt()
    {
        _wktPoints = null;
        _wktLineString = null;
        _wktPolygonRing = null;
        _status = null;

        if (string.IsNullOrWhiteSpace(_wktInput)) return;

        var trimmed = _wktInput.Trim();

        if (trimmed.StartsWith("MULTIPOINT", StringComparison.OrdinalIgnoreCase))
        {
            _wktPoints = WktParser.ParseMultiPoint(trimmed);
            _status = $"Parsed MULTIPOINT: {_wktPoints.Count} points shown as markers.";
        }
        else if (trimmed.StartsWith("POINT", StringComparison.OrdinalIgnoreCase))
        {
            var p = WktParser.ParsePoint(trimmed);
            if (p.HasValue)
            {
                _wktPoints = new List<LatLngLiteral> { p.Value };
                _status = $"Parsed POINT: ({p.Value.Lat:F5}, {p.Value.Lng:F5}) — shown as marker.";
            }
            else
            {
                _status = "Failed to parse POINT.";
            }
        }
        else if (trimmed.StartsWith("LINESTRING", StringComparison.OrdinalIgnoreCase))
        {
            _wktLineString = WktParser.ParseLineString(trimmed);
            _wktPoints = _wktLineString;
            _status = $"Parsed LINESTRING: {_wktLineString.Count} vertices — shown as red polyline with markers.";
        }
        else if (trimmed.StartsWith("POLYGON", StringComparison.OrdinalIgnoreCase))
        {
            var rings = WktParser.ParsePolygon(trimmed);
            if (rings.Count > 0)
            {
                _wktPolygonRing = rings[0];
                _wktPoints = rings[0];
                _status = $"Parsed POLYGON: {rings.Count} ring(s), {rings[0].Count} vertices — shown as green polygon with markers.";
            }
            else
            {
                _status = "Failed to parse POLYGON.";
            }
        }
        else
        {
            _status = "Unsupported WKT type. Supported: POINT, LINESTRING, POLYGON, MULTIPOINT.";
        }
    }

    private void ExportGeoJson()
    {
        if (_wktPoints == null || _wktPoints.Count == 0)
        {
            _geoJsonOutput = "No points to export. Parse some WKT first.";
            return;
        }

        if (_wktPolygonRing != null)
        {
            _geoJsonOutput = GeoJsonExporter.ToFeatureCollection(new[]
            {
                GeoJsonExporter.ToPolygonFeature(_wktPolygonRing)
            });
        }
        else if (_wktLineString != null)
        {
            _geoJsonOutput = GeoJsonExporter.ToFeatureCollection(new[]
            {
                GeoJsonExporter.ToLineStringFeature(_wktLineString)
            });
        }
        else
        {
            var features = _wktPoints.Select(p => GeoJsonExporter.ToGeoJsonFeature(p)).ToList();
            _geoJsonOutput = GeoJsonExporter.ToFeatureCollection(features);
        }

        _status = "GeoJSON exported. See output below.";
    }

    private void DecodePolyline()
    {
        if (string.IsNullOrWhiteSpace(_polylineInput))
        {
            _polylineOutput = "Enter an encoded polyline string.";
            return;
        }

        try
        {
            var points = FlexiblePolyline.Decode(_polylineInput);
            _wktPoints = points;
            _wktLineString = points.Count > 1 ? points : null;
            _wktPolygonRing = null;
            _polylineOutput = $"Decoded {points.Count} points:\n" +
                string.Join("\n", points.Select(p => $"  ({p.Lat:F5}, {p.Lng:F5})"));
            _status = $"Decoded {points.Count} points — shown on map.";
        }
        catch (Exception ex)
        {
            _polylineOutput = $"Decode error: {ex.Message}";
        }
    }

    private void EncodeCurrentPoints()
    {
        if (_wktPoints == null || _wktPoints.Count == 0)
        {
            _polylineOutput = "No points to encode. Parse some WKT first.";
            return;
        }

        var encoded = FlexiblePolyline.Encode(_wktPoints);
        _polylineInput = encoded;
        _polylineOutput = $"Encoded {_wktPoints.Count} points → {encoded}";
    }
}
