@page "/rest-api/isoline"
@inject IIsolineService IsolineService
@inject IRestApiDocService DocService

<PageTitle>Isoline â€” HerePlatform.NET Docs</PageTitle>

<div class="doc-content">
    <h1>IIsolineService</h1>
    @if (_apiName is not null)
    {
        <span class="badge bg-info text-dark mb-2">@_apiName @_apiVersion</span>
    }
    <p class="lead">@_serviceDescription</p>
    <ApiKeyWarning />

    <h2>CalculateIsolineAsync</h2>
    <p>@_methodDescription</p>
    <ParamTable Parameters="@_params" />

    <h5>Example Response (Success)</h5>
    <CodeBlock Language="json" Code="@_successExample" />

    <TryItPanel TResult="IsolineResult" OnExecute="ExecuteIsoline">
        <FormContent>
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">Center Lat</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_lat" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Center Lng</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_lng" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Range Type</label>
                    <select class="form-select form-select-sm" @bind="_rangeType">
                        <option value="@IsolineRangeType.Time">Time (seconds)</option>
                        <option value="@IsolineRangeType.Distance">Distance (meters)</option>
                        <option value="@IsolineRangeType.Consumption">Consumption</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Transport Mode</label>
                    <select class="form-select form-select-sm" @bind="_transportMode">
                        <option value="@TransportMode.Car">Car</option>
                        <option value="@TransportMode.Truck">Truck</option>
                        <option value="@TransportMode.Pedestrian">Pedestrian</option>
                    </select>
                </div>
            </div>
            <div class="row g-2 mt-1">
                <div class="col-md-6">
                    <label class="form-label">Ranges (comma-separated)</label>
                    <input class="form-control form-control-sm" @bind="_rangesText" placeholder="300,600,900" />
                </div>
            </div>
        </FormContent>
    </TryItPanel>
</div>

@code {
    private double _lat = 52.5308, _lng = 13.3847;
    private IsolineRangeType _rangeType = IsolineRangeType.Time;
    private TransportMode _transportMode = TransportMode.Car;
    private string _rangesText = "300,600,900";

    private Task<IsolineResult> ExecuteIsoline()
    {
        var parts = _rangesText.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        var ranges = new List<int>(parts.Length);
        foreach (var s in parts)
        {
            if (!int.TryParse(s, CultureInfo.InvariantCulture, out var value))
                throw new ArgumentException($"Invalid range value: '{s}'. Enter comma-separated integers (e.g. 300,600,900).");
            ranges.Add(value);
        }

        return IsolineService.CalculateIsolineAsync(new IsolineRequest
        {
            Center = new LatLngLiteral(_lat, _lng),
            Ranges = ranges,
            RangeType = _rangeType,
            TransportMode = _transportMode
        });
    }

    private string _serviceDescription = "";
    private string _methodDescription = "";
    private string? _apiName;
    private string? _apiVersion;
    private List<ParamDoc> _params = [];

    protected override async Task OnInitializedAsync()
    {
        await DocService.InitializeAsync();
        var svc = DocService.GetService(nameof(IIsolineService));
        _serviceDescription = svc?.Description ?? "";
        _apiName = svc?.ApiName;
        _apiVersion = svc?.ApiVersion;
        _methodDescription = DocService.GetMethod(nameof(IIsolineService), nameof(IIsolineService.CalculateIsolineAsync))?.Description ?? "";
        _params = DocService.GetMethodParams(nameof(IIsolineService), nameof(IIsolineService.CalculateIsolineAsync));
    }

    private const string _successExample = @"{
  ""isolines"": [
    {
      ""range"": 300,
      ""encodedPolyline"": ""BG...(encoded)..."",
      ""polygon"": [
        { ""lat"": 52.535, ""lng"": 13.380 },
        { ""lat"": 52.528, ""lng"": 13.392 },
        { ""lat"": 52.525, ""lng"": 13.378 }
      ]
    }
  ]
}";
}
