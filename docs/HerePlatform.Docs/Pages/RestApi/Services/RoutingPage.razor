@page "/rest-api/routing"
@inject IRoutingService RoutingService
@inject IRestApiDocService DocService

<PageTitle>Routing â€” HerePlatform.NET Docs</PageTitle>

<div class="doc-content">
    <h1>IRoutingService</h1>
    @if (_apiName is not null)
    {
        <span class="badge bg-info text-dark mb-2">@_apiName @_apiVersion</span>
    }
    <p class="lead">@_serviceDescription</p>
    <ApiKeyWarning />

    <h2>CalculateRouteAsync</h2>
    <p>@_methodDescription</p>
    <ParamTable Parameters="@_params" />

    <h5>Example Response (Success)</h5>
    <CodeBlock Language="json" Code="@_successExample" />
    <h5>Example Response (Error)</h5>
    <CodeBlock Language="json" Code="@_errorExample" />

    <TryItPanel TResult="RoutingResult" OnExecute="ExecuteRoute">
        <FormContent>
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">Origin Lat</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_originLat" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Origin Lng</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_originLng" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Dest Lat</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_destLat" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Dest Lng</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_destLng" />
                </div>
            </div>
            <div class="row g-2 mt-1">
                <div class="col-md-3">
                    <label class="form-label">Transport Mode</label>
                    <select class="form-select form-select-sm" @bind="_transportMode">
                        <option value="@TransportMode.Car">Car</option>
                        <option value="@TransportMode.Truck">Truck</option>
                        <option value="@TransportMode.Pedestrian">Pedestrian</option>
                        <option value="@TransportMode.Bicycle">Bicycle</option>
                        <option value="@TransportMode.Scooter">Scooter</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Routing Mode</label>
                    <select class="form-select form-select-sm" @bind="_routingMode">
                        <option value="@RoutingMode.Fast">Fast</option>
                        <option value="@RoutingMode.Short">Short</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Alternatives</label>
                    <input type="number" class="form-control form-control-sm" @bind="_alternatives" min="0" max="6" />
                </div>
                <div class="col-md-3 d-flex align-items-end gap-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="retPoly" @bind="_returnPolyline" />
                        <label class="form-check-label" for="retPoly">Polyline</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="retInstr" @bind="_returnInstructions" />
                        <label class="form-check-label" for="retInstr">Instructions</label>
                    </div>
                </div>
            </div>
            <div class="row g-2 mt-1">
                <div class="col-12">
                    <label class="form-label">Avoid</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="avTolls" @bind="_avoidTolls" />
                            <label class="form-check-label" for="avTolls">Tolls</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="avHwy" @bind="_avoidHighways" />
                            <label class="form-check-label" for="avHwy">Highways</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="avFerry" @bind="_avoidFerries" />
                            <label class="form-check-label" for="avFerry">Ferries</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="avTunnel" @bind="_avoidTunnels" />
                            <label class="form-check-label" for="avTunnel">Tunnels</label>
                        </div>
                    </div>
                </div>
            </div>

            @* Via waypoints *@
            <div class="mt-2">
                <label class="form-label">Via Waypoints</label>
                @for (int i = 0; i < _viaPoints.Count; i++)
                {
                    var idx = i;
                    <div class="row g-1 mb-1">
                        <div class="col-5">
                            <input type="number" step="any" class="form-control form-control-sm" placeholder="Lat"
                                   value="@_viaPoints[idx].lat"
                                   @onchange="e => { if (double.TryParse(e.Value?.ToString(), CultureInfo.InvariantCulture, out var parsed)) { var v = _viaPoints[idx]; _viaPoints[idx] = (parsed, v.lng); } }" />
                        </div>
                        <div class="col-5">
                            <input type="number" step="any" class="form-control form-control-sm" placeholder="Lng"
                                   value="@_viaPoints[idx].lng"
                                   @onchange="e => { if (double.TryParse(e.Value?.ToString(), CultureInfo.InvariantCulture, out var parsed)) { var v = _viaPoints[idx]; _viaPoints[idx] = (v.lat, parsed); } }" />
                        </div>
                        <div class="col-2">
                            <button class="btn btn-sm btn-outline-danger w-100" @onclick="() => _viaPoints.RemoveAt(idx)">Remove</button>
                        </div>
                    </div>
                }
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => _viaPoints.Add((52.5200, 13.4050))">+ Add Via</button>
            </div>
        </FormContent>
    </TryItPanel>
</div>

@code {
    private double _originLat = 52.5308, _originLng = 13.3847;
    private double _destLat = 52.5163, _destLng = 13.3777;
    private TransportMode _transportMode = TransportMode.Car;
    private RoutingMode _routingMode = RoutingMode.Fast;
    private int _alternatives = 0;
    private bool _returnPolyline = true;
    private bool _returnInstructions;
    private bool _avoidTolls, _avoidHighways, _avoidFerries, _avoidTunnels;
    private List<(double lat, double lng)> _viaPoints = [];

    private Task<RoutingResult> ExecuteRoute()
    {
        var avoid = RoutingAvoidFeature.None;
        if (_avoidTolls) avoid |= RoutingAvoidFeature.Tolls;
        if (_avoidHighways) avoid |= RoutingAvoidFeature.Highways;
        if (_avoidFerries) avoid |= RoutingAvoidFeature.Ferries;
        if (_avoidTunnels) avoid |= RoutingAvoidFeature.Tunnels;

        return RoutingService.CalculateRouteAsync(new RoutingRequest
        {
            Origin = new LatLngLiteral(_originLat, _originLng),
            Destination = new LatLngLiteral(_destLat, _destLng),
            TransportMode = _transportMode,
            RoutingMode = _routingMode,
            Alternatives = _alternatives,
            ReturnPolyline = _returnPolyline,
            ReturnInstructions = _returnInstructions,
            Avoid = avoid,
            Via = _viaPoints.Count > 0
                ? _viaPoints.Select(v => new LatLngLiteral(v.lat, v.lng)).ToList()
                : null
        });
    }

    private string _serviceDescription = "";
    private string _methodDescription = "";
    private string? _apiName;
    private string? _apiVersion;
    private List<ParamDoc> _params = [];

    protected override async Task OnInitializedAsync()
    {
        await DocService.InitializeAsync();
        var svc = DocService.GetService(nameof(IRoutingService));
        _serviceDescription = svc?.Description ?? "";
        _apiName = svc?.ApiName;
        _apiVersion = svc?.ApiVersion;
        _methodDescription = DocService.GetMethod(nameof(IRoutingService), nameof(IRoutingService.CalculateRouteAsync))?.Description ?? "";
        _params = DocService.GetMethodParams(nameof(IRoutingService), nameof(IRoutingService.CalculateRouteAsync));
    }

    private const string _successExample = @"{
  ""routes"": [
    {
      ""sections"": [
        {
          ""polyline"": ""BG...(encoded)..."",
          ""transport"": ""car"",
          ""summary"": {
            ""duration"": 420,
            ""length"": 3200,
            ""baseDuration"": 380
          }
        }
      ]
    }
  ]
}";

    private const string _errorExample = @"{
  ""status"": 401,
  ""title"": ""Unauthorized"",
  ""detail"": ""No valid API Key provided.""
}";
}
