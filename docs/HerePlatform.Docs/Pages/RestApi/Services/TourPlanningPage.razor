@page "/rest-api/tour-planning"
@inject ITourPlanningService TourPlanningService
@inject IRestApiDocService DocService

<PageTitle>Tour Planning â€” HerePlatform.NET Docs</PageTitle>

<div class="doc-content">
    <h1>ITourPlanningService</h1>
    @if (_apiName is not null)
    {
        <span class="badge bg-info text-dark mb-2">@_apiName @_apiVersion</span>
    }
    <p class="lead">@_serviceDescription</p>
    <ApiKeyWarning />

    <h2>SolveAsync</h2>
    <p>@_methodDescription</p>
    <ParamTable Parameters="@_params" />

    <h5>Example Response (Success)</h5>
    <CodeBlock Language="json" Code="@_successExample" />

    <TryItPanel TResult="TourPlanningResult" OnExecute="ExecuteSolve">
        <FormContent>
            <h6>Vehicle</h6>
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">Depot Lat</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_depotLat" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Depot Lng</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_depotLng" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Profile</label>
                    <select class="form-select form-select-sm" @bind="_profile">
                        <option value="car">Car</option>
                        <option value="truck">Truck</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Capacity</label>
                    <input type="number" class="form-control form-control-sm" @bind="_capacity" min="1" />
                </div>
            </div>

            <h6 class="mt-3">Delivery Jobs</h6>
            @for (int i = 0; i < _jobs.Count; i++)
            {
                var idx = i;
                <div class="row g-1 mb-1">
                    <div class="col-3">
                        <input class="form-control form-control-sm" placeholder="ID" value="@_jobs[idx].id"
                               @onchange="e => _jobs[idx] = _jobs[idx] with { id = e.Value?.ToString() ?? string.Empty }" />
                    </div>
                    <div class="col-3">
                        <input type="number" step="any" class="form-control form-control-sm" placeholder="Lat"
                               value="@_jobs[idx].lat"
                               @onchange="e => { if (double.TryParse(e.Value?.ToString(), CultureInfo.InvariantCulture, out var parsed)) _jobs[idx] = _jobs[idx] with { lat = parsed }; }" />
                    </div>
                    <div class="col-3">
                        <input type="number" step="any" class="form-control form-control-sm" placeholder="Lng"
                               value="@_jobs[idx].lng"
                               @onchange="e => { if (double.TryParse(e.Value?.ToString(), CultureInfo.InvariantCulture, out var parsed)) _jobs[idx] = _jobs[idx] with { lng = parsed }; }" />
                    </div>
                    <div class="col-2">
                        <input type="number" class="form-control form-control-sm" placeholder="Duration (s)"
                               value="@_jobs[idx].duration"
                               @onchange="e => { if (int.TryParse(e.Value?.ToString(), out var parsed)) _jobs[idx] = _jobs[idx] with { duration = parsed }; }" />
                    </div>
                    <div class="col-1">
                        <button class="btn btn-sm btn-outline-danger w-100" @onclick="() => _jobs.RemoveAt(idx)">X</button>
                    </div>
                </div>
            }
            <button class="btn btn-sm btn-outline-secondary" @onclick="AddJob">+ Add Job</button>
        </FormContent>
    </TryItPanel>
</div>

@code {
    private double _depotLat = 52.53, _depotLng = 13.38;
    private string _profile = "car";
    private int _capacity = 20;

    private record struct JobEntry(string id, double lat, double lng, int duration);
    private List<JobEntry> _jobs =
    [
        new("delivery-1", 52.5163, 13.3777, 300),
        new("delivery-2", 52.5200, 13.4050, 600)
    ];

    private void AddJob() => _jobs.Add(new($"delivery-{_jobs.Count + 1}", 52.52, 13.40, 300));

    private Task<TourPlanningResult> ExecuteSolve()
    {
        var problem = new TourPlanningProblem
        {
            Plan = new TourPlan
            {
                Jobs = _jobs.Select(j => new TourJob
                {
                    Id = j.id,
                    Places = new TourJobPlaces
                    {
                        Deliveries =
                        [
                            new TourJobPlace
                            {
                                Location = new LatLngLiteral(j.lat, j.lng),
                                Duration = j.duration
                            }
                        ]
                    }
                }).ToList()
            },
            Fleet = new TourFleet
            {
                Types =
                [
                    new TourVehicleType
                    {
                        Id = "vehicle-1",
                        Profile = _profile,
                        Amount = 1,
                        Capacity = [_capacity],
                        Costs = new TourVehicleCosts { Fixed = 10, Distance = 0.001, Time = 0.01 },
                        Shifts =
                        [
                            new TourVehicleShift
                            {
                                Start = new TourShiftEnd
                                {
                                    Location = new LatLngLiteral(_depotLat, _depotLng),
                                    Time = DateTime.UtcNow.Date.AddHours(8).ToString("O")
                                },
                                End = new TourShiftEnd
                                {
                                    Location = new LatLngLiteral(_depotLat, _depotLng),
                                    Time = DateTime.UtcNow.Date.AddHours(18).ToString("O")
                                }
                            }
                        ]
                    }
                ]
            }
        };

        return TourPlanningService.SolveAsync(problem);
    }

    private string _serviceDescription = "";
    private string _methodDescription = "";
    private string? _apiName;
    private string? _apiVersion;
    private List<ParamDoc> _params = [];

    protected override async Task OnInitializedAsync()
    {
        await DocService.InitializeAsync();
        var svc = DocService.GetService(nameof(ITourPlanningService));
        _serviceDescription = svc?.Description ?? "";
        _apiName = svc?.ApiName;
        _apiVersion = svc?.ApiVersion;
        _methodDescription = DocService.GetMethod(nameof(ITourPlanningService), nameof(ITourPlanningService.SolveAsync))?.Description ?? "";
        _params = DocService.GetMethodParams(nameof(ITourPlanningService), nameof(ITourPlanningService.SolveAsync));
    }

    private const string _successExample = @"{
  ""tours"": [
    {
      ""vehicleId"": ""vehicle-1"",
      ""stops"": [
        { ""location"": { ""lat"": 52.53, ""lng"": 13.38 }, ""activities"": [{ ""type"": ""departure"" }] },
        { ""location"": { ""lat"": 52.5163, ""lng"": 13.3777 }, ""activities"": [{ ""type"": ""delivery"", ""jobId"": ""delivery-1"" }] },
        { ""location"": { ""lat"": 52.52, ""lng"": 13.405 }, ""activities"": [{ ""type"": ""delivery"", ""jobId"": ""delivery-2"" }] },
        { ""location"": { ""lat"": 52.53, ""lng"": 13.38 }, ""activities"": [{ ""type"": ""arrival"" }] }
      ],
      ""statistic"": { ""cost"": 35.2, ""distance"": 8500, ""duration"": 2400 }
    }
  ],
  ""statistic"": { ""cost"": 35.2, ""distance"": 8500, ""duration"": 2400 }
}";
}
