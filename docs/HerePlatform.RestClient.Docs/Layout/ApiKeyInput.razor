@inject DocsApiKeyService ApiKeyService
@inject IJSRuntime JS

<div class="api-key-input d-flex align-items-center gap-2">
    <label for="apiKeyInput" class="text-light text-nowrap mb-0 small">API Key:</label>
    <input id="apiKeyInput"
           type="password"
           placeholder="Enter HERE API Key..."
           @bind="_apiKey"
           @bind:event="oninput"
           @onkeydown="OnKeyDown"
           class="form-control form-control-sm"
           style="max-width: 260px;" />
    <button class="btn btn-sm btn-primary text-nowrap" @onclick="ApplyKey" disabled="@string.IsNullOrWhiteSpace(_apiKey)">
        Apply
    </button>
    @if (_applied)
    {
        <span class="badge bg-success">Active</span>
    }
</div>

@code {
    private string? _apiKey;
    private bool _applied;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var stored = await JS.InvokeAsync<string?>("sessionStorage.getItem", "hereRestApiKey");
                if (!string.IsNullOrWhiteSpace(stored))
                {
                    _apiKey = stored;
                    _applied = true;
                    ApiKeyService.UpdateApiKey(stored);
                    StateHasChanged();
                }
            }
            catch { /* sessionStorage unavailable */ }
        }
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_apiKey))
            await ApplyKey();
    }

    private async Task ApplyKey()
    {
        if (string.IsNullOrWhiteSpace(_apiKey)) return;

        await JS.InvokeVoidAsync("sessionStorage.setItem", "hereRestApiKey", _apiKey);
        ApiKeyService.UpdateApiKey(_apiKey);
        _applied = true;
    }
}
