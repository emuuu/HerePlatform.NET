@page "/services/geofencing"
@inject IGeofencingService GeofencingService
@inject IRestApiDocService DocService

<PageTitle>Geofencing â€” HerePlatform.RestClient Docs</PageTitle>

<div class="doc-content">
    <h1>IGeofencingService</h1>
    <p class="lead">@_serviceDescription</p>

    <div class="alert alert-info">
        This service runs entirely client-side. No API key is required.
    </div>

    <h2>CheckPositionAsync</h2>
    <p>@_methodDescription</p>
    <ParamTable Parameters="@_params" />

    <h5>Example Response (Success)</h5>
    <CodeBlock Language="json" Code="@_successExample" />

    <TryItPanel TResult="GeofenceCheckResult" OnExecute="ExecuteCheck">
        <FormContent>
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="form-label">Position Lat</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_posLat" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Position Lng</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_posLng" />
                </div>
            </div>

            <h6 class="mt-3">Predefined Zones</h6>
            <div class="small text-muted mb-2">
                <strong>Berlin Mitte (Polygon):</strong> A polygon around Berlin Mitte.<br />
                <strong>Brandenburger Tor (Circle):</strong> 200m circle around Brandenburger Tor.
            </div>
        </FormContent>
    </TryItPanel>

    <h2>Zone Types</h2>

    <h3>Polygon Zone</h3>
    <p>Define a zone using a list of vertices. Uses the ray casting algorithm for point-in-polygon testing.</p>
    <CodeBlock Language="csharp" Code="@_polygonExample" />

    <h3>Circle Zone</h3>
    <p>Define a zone using a center point and radius in meters. Uses the Haversine formula for distance calculation.</p>
    <CodeBlock Language="csharp" Code="@_circleExample" />
</div>

@code {
    // Position: Invalidenstr 116
    private double _posLat = 52.5308;
    private double _posLng = 13.3847;

    private static readonly List<GeofenceZone> _zones =
    [
        new GeofenceZone
        {
            Id = "berlin-mitte",
            Name = "Berlin Mitte",
            Type = "polygon",
            Vertices =
            [
                new LatLngLiteral(52.54, 13.36),
                new LatLngLiteral(52.54, 13.42),
                new LatLngLiteral(52.50, 13.42),
                new LatLngLiteral(52.50, 13.36)
            ]
        },
        new GeofenceZone
        {
            Id = "brandenburger-tor",
            Name = "Brandenburger Tor",
            Type = "circle",
            Center = new LatLngLiteral(52.5163, 13.3777),
            Radius = 200
        }
    ];

    private Task<GeofenceCheckResult> ExecuteCheck() =>
        GeofencingService.CheckPositionAsync(new LatLngLiteral(_posLat, _posLng), _zones);

    private string _serviceDescription = "";
    private string _methodDescription = "";
    private List<ParamDoc> _params = [];

    protected override async Task OnInitializedAsync()
    {
        await DocService.InitializeAsync();
        var svc = DocService.GetService("IGeofencingService");
        _serviceDescription = svc?.Description ?? "";
        _methodDescription = DocService.GetMethod("IGeofencingService", "CheckPositionAsync")?.Description ?? "";
        _params = DocService.GetMethodParams("IGeofencingService", "CheckPositionAsync");
    }

    private const string _successExample = @"{
  ""isInside"": true,
  ""matchedZoneIds"": [""berlin-mitte""]
}";

    private const string _polygonExample = @"new GeofenceZone
{
    Id = ""office-area"",
    Name = ""Office Area"",
    Type = ""polygon"",
    Vertices = new List<LatLngLiteral>
    {
        new(52.54, 13.36),
        new(52.54, 13.42),
        new(52.50, 13.42),
        new(52.50, 13.36)
    }
}";

    private const string _circleExample = @"new GeofenceZone
{
    Id = ""landmark"",
    Name = ""Brandenburger Tor"",
    Type = ""circle"",
    Center = new LatLngLiteral(52.5163, 13.3777),
    Radius = 200  // meters
}";
}
