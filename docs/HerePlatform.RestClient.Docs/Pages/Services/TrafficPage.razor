@page "/services/traffic"
@inject ITrafficService TrafficService
@inject IRestApiDocService DocService

<PageTitle>Traffic — HerePlatform.RestClient Docs</PageTitle>

<div class="doc-content">
    <h1>ITrafficService</h1>
    <p class="lead">@_serviceDescription</p>
    <ApiKeyWarning />

    @* ── GetTrafficIncidentsAsync ── *@
    <h2>GetTrafficIncidentsAsync</h2>
    <p>@_incidentsMethodDescription</p>
    <ParamTable Parameters="@_incidentsParams" />

    <h5>Example Response (Success)</h5>
    <CodeBlock Language="json" Code="@_incidentsSuccessExample" />

    <TryItPanel TResult="TrafficIncidentsResult" OnExecute="ExecuteIncidents">
        <FormContent>
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">North</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_incNorth" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">South</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_incSouth" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">East</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_incEast" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">West</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_incWest" />
                </div>
            </div>
        </FormContent>
    </TryItPanel>

    @* ── GetTrafficFlowAsync ── *@
    <h2>GetTrafficFlowAsync</h2>
    <p>@_flowMethodDescription</p>
    <ParamTable Parameters="@_flowParams" />

    <h5>Example Response (Success)</h5>
    <CodeBlock Language="json" Code="@_flowSuccessExample" />

    <TryItPanel TResult="TrafficFlowResult" OnExecute="ExecuteFlow">
        <FormContent>
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">North</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_flowNorth" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">South</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_flowSouth" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">East</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_flowEast" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">West</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_flowWest" />
                </div>
            </div>
        </FormContent>
    </TryItPanel>
</div>

@code {
    // Berlin city center bounding box
    private double _incNorth = 52.54, _incSouth = 52.50, _incEast = 13.42, _incWest = 13.35;
    private double _flowNorth = 52.54, _flowSouth = 52.50, _flowEast = 13.42, _flowWest = 13.35;

    private Task<TrafficIncidentsResult> ExecuteIncidents() =>
        TrafficService.GetTrafficIncidentsAsync(_incNorth, _incSouth, _incEast, _incWest);

    private Task<TrafficFlowResult> ExecuteFlow() =>
        TrafficService.GetTrafficFlowAsync(_flowNorth, _flowSouth, _flowEast, _flowWest);

    private string _serviceDescription = "";
    private string _incidentsMethodDescription = "";
    private string _flowMethodDescription = "";
    private List<ParamDoc> _incidentsParams = [];
    private List<ParamDoc> _flowParams = [];

    protected override async Task OnInitializedAsync()
    {
        await DocService.InitializeAsync();
        var svc = DocService.GetService("ITrafficService");
        _serviceDescription = svc?.Description ?? "";
        _incidentsMethodDescription = DocService.GetMethod("ITrafficService", "GetTrafficIncidentsAsync")?.Description ?? "";
        _flowMethodDescription = DocService.GetMethod("ITrafficService", "GetTrafficFlowAsync")?.Description ?? "";
        _incidentsParams = DocService.GetMethodParams("ITrafficService", "GetTrafficIncidentsAsync");
        _flowParams = DocService.GetMethodParams("ITrafficService", "GetTrafficFlowAsync");
    }

    private const string _incidentsSuccessExample = @"{
  ""incidents"": [
    {
      ""type"": ""construction"",
      ""severity"": 2,
      ""description"": ""Road construction on Friedrichstr."",
      ""roadName"": ""Friedrichstraße"",
      ""position"": { ""lat"": 52.5200, ""lng"": 13.3880 },
      ""startTime"": ""2025-01-01T06:00:00Z"",
      ""endTime"": ""2025-03-31T18:00:00Z""
    }
  ]
}";

    private const string _flowSuccessExample = @"{
  ""items"": [
    {
      ""currentSpeed"": 35.5,
      ""freeFlowSpeed"": 50.0,
      ""jamFactor"": 3.2,
      ""roadName"": ""Unter den Linden"",
      ""position"": { ""lat"": 52.5170, ""lng"": 13.3888 }
    }
  ]
}";
}
