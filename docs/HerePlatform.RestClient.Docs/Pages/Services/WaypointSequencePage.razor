@page "/services/waypoint-sequence"
@inject IWaypointSequenceService WaypointSequenceService
@inject IRestApiDocService DocService

<PageTitle>Waypoint Sequence — HerePlatform.RestClient Docs</PageTitle>

<div class="doc-content">
    <h1>IWaypointSequenceService</h1>
    <p class="lead">@_serviceDescription</p>
    <ApiKeyWarning />

    <h2>OptimizeSequenceAsync</h2>
    <p>@_methodDescription</p>
    <ParamTable Parameters="@_params" />

    <h5>Example Response (Success)</h5>
    <CodeBlock Language="json" Code="@_successExample" />

    <TryItPanel TResult="WaypointSequenceResult" OnExecute="ExecuteOptimize">
        <FormContent>
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">Start Lat</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_startLat" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Start Lng</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_startLng" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">End Lat</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_endLat" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">End Lng</label>
                    <input type="number" step="any" class="form-control form-control-sm" @bind="_endLng" />
                </div>
            </div>
            <div class="row g-2 mt-1">
                <div class="col-md-4">
                    <label class="form-label">Transport Mode</label>
                    <select class="form-select form-select-sm" @bind="_transportMode">
                        <option value="@TransportMode.Car">Car</option>
                        <option value="@TransportMode.Truck">Truck</option>
                        <option value="@TransportMode.Pedestrian">Pedestrian</option>
                        <option value="@TransportMode.Bicycle">Bicycle</option>
                    </select>
                </div>
            </div>

            <div class="mt-2">
                <label class="form-label fw-semibold">Waypoints</label>
                @for (int i = 0; i < _waypoints.Count; i++)
                {
                    var idx = i;
                    <div class="row g-1 mb-1">
                        <div class="col-5">
                            <input type="number" step="any" class="form-control form-control-sm" placeholder="Lat"
                                   value="@_waypoints[idx].lat"
                                   @onchange="e => { var v = _waypoints[idx]; _waypoints[idx] = (double.Parse(e.Value?.ToString()!, CultureInfo.InvariantCulture), v.lng); }" />
                        </div>
                        <div class="col-5">
                            <input type="number" step="any" class="form-control form-control-sm" placeholder="Lng"
                                   value="@_waypoints[idx].lng"
                                   @onchange="e => { var v = _waypoints[idx]; _waypoints[idx] = (v.lat, double.Parse(e.Value?.ToString()!, CultureInfo.InvariantCulture)); }" />
                        </div>
                        <div class="col-2">
                            <button class="btn btn-sm btn-outline-danger w-100" @onclick="() => _waypoints.RemoveAt(idx)">Remove</button>
                        </div>
                    </div>
                }
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => _waypoints.Add((52.5200, 13.4050))">+ Add Waypoint</button>
            </div>
        </FormContent>
    </TryItPanel>
</div>

@code {
    // Berlin: Invalidenstr → Brandenburger Tor
    private double _startLat = 52.5308, _startLng = 13.3847;
    private double _endLat = 52.5163, _endLng = 13.3777;
    private TransportMode _transportMode = TransportMode.Car;
    private List<(double lat, double lng)> _waypoints =
    [
        (52.5200, 13.4050),  // Alexanderplatz
        (52.5075, 13.3903),  // Checkpoint Charlie
        (52.5145, 13.3501)   // Zoologischer Garten
    ];

    private Task<WaypointSequenceResult> ExecuteOptimize() =>
        WaypointSequenceService.OptimizeSequenceAsync(new WaypointSequenceRequest
        {
            Start = new LatLngLiteral(_startLat, _startLng),
            End = new LatLngLiteral(_endLat, _endLng),
            TransportMode = _transportMode,
            Waypoints = _waypoints.Select(w => new LatLngLiteral(w.lat, w.lng)).ToList()
        });

    private string _serviceDescription = "";
    private string _methodDescription = "";
    private List<ParamDoc> _params = [];

    protected override async Task OnInitializedAsync()
    {
        await DocService.InitializeAsync();
        var svc = DocService.GetService("IWaypointSequenceService");
        _serviceDescription = svc?.Description ?? "";
        _methodDescription = DocService.GetMethod("IWaypointSequenceService", "OptimizeSequenceAsync")?.Description ?? "";
        _params = DocService.GetMethodParams("IWaypointSequenceService", "OptimizeSequenceAsync");
    }

    private const string _successExample = @"{
  ""optimizedIndices"": [2, 0, 1],
  ""optimizedWaypoints"": [
    { ""lat"": 52.5145, ""lng"": 13.3501 },
    { ""lat"": 52.5200, ""lng"": 13.4050 },
    { ""lat"": 52.5075, ""lng"": 13.3903 }
  ],
  ""totalDistance"": 12500,
  ""totalDuration"": 1560
}";
}
